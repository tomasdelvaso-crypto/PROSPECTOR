<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ventapel Prospector v2.0 - Sistema Inteligente de Prospec√ß√£o B2B</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <nav class="bg-gradient-to-r from-blue-900 to-indigo-800 shadow-xl">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-5">
                <div>
                    <h1 class="text-3xl font-bold text-white">Ventapel Prospector v2.0</h1>
                    <p class="text-sm text-blue-200">Sistema Inteligente de Qualifica√ß√£o B2B com An√°lise PPVVC</p>
                </div>
                <div class="flex gap-2">
                    <span class="bg-green-500 px-3 py-1 rounded-full text-white text-xs">Apollo.io</span>
                    <span class="bg-yellow-500 px-3 py-1 rounded-full text-white text-xs">Lusha</span>
                    <span class="bg-purple-500 px-3 py-1 rounded-full text-white text-xs">Serper</span>
                    <span class="bg-indigo-500 px-3 py-1 rounded-full text-white text-xs">Claude AI</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- Alerta de mejora -->
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
            <div class="flex">
                <i class="fas fa-exclamation-triangle text-yellow-400 mr-3"></i>
                <div>
                    <p class="font-semibold">Sistema v2.0 - Melhorias Implementadas</p>
                    <ul class="text-sm mt-2 space-y-1">
                        <li>‚úÖ Busca primeiro por tipo de empresa e setor relevante</li>
                        <li>‚úÖ Enriquecimento completo com Apollo + Lusha funcionando</li>
                        <li>‚úÖ An√°lise inteligente focada em potencial de fechamento de caixas</li>
                        <li>‚úÖ Dados salvos localmente (CSV export melhorado)</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Panel de b√∫squeda mejorado -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">
                <i class="fas fa-industry mr-2 text-blue-600"></i>Busca por Setor e Potencial
            </h2>
            
            <div class="grid grid-cols-3 gap-4 mb-4">
                <!-- B√∫squeda por SECTOR primero -->
                <div>
                    <label class="block text-sm font-semibold mb-1 text-gray-700">
                        üè≠ Setor Principal (PRIORIDADE)
                    </label>
                    <select id="sectorFilter" class="w-full p-3 border-2 border-blue-200 rounded-lg focus:border-blue-500">
                        <option value="high_volume">üì¶ Alto Volume (E-commerce, Fulfillment, 3PL)</option>
                        <option value="manufacturing">üè≠ Ind√∫stria (Alimentos, Bebidas, Farmac√™utica)</option>
                        <option value="automotive">üöó Automotiva e Autope√ßas</option>
                        <option value="retail">üõçÔ∏è Varejo e Distribui√ß√£o</option>
                        <option value="textil">üëî T√™xtil e Vestu√°rio</option>
                        <option value="cosmetics">üíÑ Cosm√©ticos e Beleza</option>
                        <option value="all">Todos os Setores Relevantes</option>
                    </select>
                </div>
                
                <!-- Tama√±o de empresa -->
                <div>
                    <label class="block text-sm font-semibold mb-1 text-gray-700">
                        üë• Porte (Funcion√°rios)
                    </label>
                    <select id="sizeFilter" class="w-full p-3 border-2 border-gray-200 rounded-lg">
                        <option value="500,10000">500+ (Alto potencial)</option>
                        <option value="200,500">200-500 (M√©dio potencial)</option>
                        <option value="100,200">100-200 (Potencial inicial)</option>
                        <option value="1000,10000">1000+ (Enterprise)</option>
                    </select>
                </div>
                
                <!-- Regi√≥n -->
                <div>
                    <label class="block text-sm font-semibold mb-1 text-gray-700">
                        üìç Regi√£o
                    </label>
                    <select id="locationFilter" class="w-full p-3 border-2 border-gray-200 rounded-lg">
                        <option value="S√£o Paulo, Brazil">S√£o Paulo</option>
                        <option value="Rio de Janeiro, Brazil">Rio de Janeiro</option>
                        <option value="Minas Gerais, Brazil">Minas Gerais</option>
                        <option value="Santa Catarina, Brazil">Santa Catarina</option>
                        <option value="Paran√°, Brazil">Paran√°</option>
                        <option value="Brazil">Todo Brasil</option>
                    </select>
                </div>
            </div>

            <!-- Nuevos filtros avanzados -->
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-semibold mb-1 text-gray-700">
                        üéØ Prioridade de Cargo
                    </label>
                    <select id="titlePriority" class="w-full p-3 border rounded-lg">
                        <option value="operations_first">Operations/Log√≠stica primeiro</option>
                        <option value="quality_first">Qualidade/Produ√ß√£o primeiro</option>
                        <option value="c_level">Apenas C-Level/Diretores</option>
                        <option value="all">Todos os n√≠veis</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-1 text-gray-700">
                        üìä Volume Estimado
                    </label>
                    <select id="volumeFilter" class="w-full p-3 border rounded-lg">
                        <option value="high">Alto (>1000 caixas/dia)</option>
                        <option value="medium">M√©dio (100-1000 caixas/dia)</option>
                        <option value="all">Qualquer volume</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-1 text-gray-700">
                        üîç Busca Inteligente
                    </label>
                    <select id="searchMode" class="w-full p-3 border rounded-lg">
                        <option value="deep">An√°lise Profunda (mais lenta, mais precisa)</option>
                        <option value="quick">Busca R√°pida (menos detalhes)</option>
                    </select>
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="searchProspectsV2()" 
                        class="px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:from-blue-700 hover:to-indigo-700 font-semibold shadow-lg">
                    <i class="fas fa-search mr-2"></i>Buscar Empresas Relevantes
                </button>
                
                <button onclick="exportEnhancedCSV()" 
                        class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold shadow-lg">
                    <i class="fas fa-file-excel mr-2"></i>Exportar Dados Completos
                </button>

                <button onclick="clearResults()" 
                        class="px-4 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                    <i class="fas fa-trash mr-2"></i>Limpar
                </button>
            </div>
        </div>

        <!-- M√©tricas mejoradas -->
        <div class="grid grid-cols-6 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4 border-t-4 border-blue-500">
                <div class="text-2xl font-bold text-blue-600" id="companiesFound">0</div>
                <div class="text-xs text-gray-600">Empresas Relevantes</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 border-t-4 border-green-500">
                <div class="text-2xl font-bold text-green-600" id="contactsFound">0</div>
                <div class="text-xs text-gray-600">Contatos Identificados</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 border-t-4 border-purple-500">
                <div class="text-2xl font-bold text-purple-600" id="enrichedCount">0</div>
                <div class="text-xs text-gray-600">Enriquecidos</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 border-t-4 border-yellow-500">
                <div class="text-2xl font-bold text-yellow-600" id="withPhone">0</div>
                <div class="text-xs text-gray-600">Com Telefone</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 border-t-4 border-red-500">
                <div class="text-2xl font-bold text-red-600" id="hotLeads">0</div>
                <div class="text-xs text-gray-600">üî• Hot Leads</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4 border-t-4 border-indigo-500">
                <div class="text-2xl font-bold text-indigo-600" id="estimatedBoxes">0</div>
                <div class="text-xs text-gray-600">Caixas/Dia Total</div>
            </div>
        </div>

        <!-- √Årea de resultados mejorada -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">Resultados da Busca</h3>
                <div class="flex gap-2">
                    <button onclick="sortByScore()" class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded text-sm">
                        <i class="fas fa-sort mr-1"></i>Ordenar por Score
                    </button>
                    <button onclick="filterHotOnly()" class="px-3 py-1 bg-red-100 text-red-700 rounded text-sm">
                        <i class="fas fa-fire mr-1"></i>S√≥ Hot Leads
                    </button>
                </div>
            </div>
            
            <div id="searchProgress" class="hidden mb-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-spinner fa-spin text-blue-600 mr-3"></i>
                        <div class="flex-1">
                            <div class="font-semibold text-sm" id="progressText">Iniciando busca...</div>
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="results">
                <p class="text-gray-500 text-center py-8">
                    <i class="fas fa-search text-4xl text-gray-300 mb-3 block"></i>
                    Selecione os filtros e clique em buscar
                </p>
            </div>
        </div>
    </div>

    <script>
    // Estado global mejorado
    let allProspects = [];
    let enrichedData = new Map(); // Guardar todos los datos enriquecidos
    let companiesData = new Map(); // Datos de empresas
    let enrichmentQueue = []; // Cola de contactos para enriquecer
    let totalCreditsUsed = 0; // Contador de cr√©ditos gastados
    
    // Funci√≥n para enriquecer un contacto espec√≠fico despu√©s de revisar LinkedIn
    async function enrichThisContact(encodedContact) {
        try {
            const contact = JSON.parse(atob(encodedContact));
            const contactId = contact.id || contact.name.replace(/\s/g, '_');
            const btn = document.getElementById(`enrich-btn-${contactId}`);
            
            // Cambiar estado del bot√≥n
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Enriqueciendo...';
            btn.disabled = true;
            
            // Enriquecer el contacto
            const enriched = await enrichContact(contact, contactId);
            
            // Actualizar el display con los datos obtenidos
            const dataDiv = document.getElementById(`contact-data-${contactId}`);
            dataDiv.innerHTML = `
                ${enriched.email && enriched.email !== 'email_not_unlocked@domain.com' ? `
                    <div class="text-green-600 font-semibold">
                        <i class="fas fa-check-circle mr-1"></i>
                        ${enriched.email}
                        <button onclick="navigator.clipboard.writeText('${enriched.email}')" class="ml-2 text-blue-500 hover:text-blue-700">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                ` : '<div class="text-red-400"><i class="fas fa-times-circle mr-1"></i>Email n√£o encontrado</div>'}
                
                ${enriched.phone ? `
                    <div class="text-green-600 font-semibold">
                        <i class="fas fa-check-circle mr-1"></i>
                        ${enriched.phone}
                        <button onclick="navigator.clipboard.writeText('${enriched.phone}')" class="ml-2 text-blue-500 hover:text-blue-700">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                ` : '<div class="text-red-400"><i class="fas fa-times-circle mr-1"></i>Telefone n√£o encontrado</div>'}
                
                ${enriched.serper_data?.insights ? `
                    <div class="mt-2 p-2 bg-yellow-50 rounded text-xs">
                        <p class="font-semibold">üìä Intel:</p>
                        <p>${enriched.serper_data.insights}</p>
                    </div>
                ` : ''}
            `;
            
            // Hacer an√°lisis con Claude
            const analysis = await analyzeProspect(enriched, contactId);
            
            // Mostrar an√°lisis
            const analysisDiv = document.getElementById(`analysis-${contactId}`);
            if (analysis) {
                const score = analysis.total_score || 0;
                analysisDiv.innerHTML = `
                    <div class="p-3 ${score >= 7 ? 'bg-green-50' : score >= 5 ? 'bg-yellow-50' : 'bg-gray-50'} rounded-lg border ${score >= 7 ? 'border-green-300' : 'border-gray-200'}">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-bold">An√°lise PPVVC</span>
                            <span class="text-xl font-bold ${score >= 7 ? 'text-green-600' : score >= 5 ? 'text-yellow-600' : 'text-red-600'}">
                                ${score}/10 ${score >= 7 ? 'üî•' : ''}
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-1 text-xs mb-2">
                            ${Object.entries(analysis.scores || {}).map(([key, value]) => `
                                <div class="text-center">
                                    <div class="font-semibold">${key.toUpperCase()}</div>
                                    <div class="text-lg ${value >= 7 ? 'text-green-600' : value >= 5 ? 'text-yellow-600' : 'text-red-600'}">${value}</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        ${analysis.key_insight ? `
                            <div class="p-2 bg-white rounded text-xs">
                                <span class="font-semibold">üí° Insight:</span> ${analysis.key_insight}
                            </div>
                        ` : ''}
                        
                        ${analysis.estimated_boxes_per_day ? `
                            <div class="mt-2 text-center">
                                <span class="text-xs text-gray-600">Volume estimado:</span>
                                <span class="text-sm font-bold text-indigo-600 ml-1">${analysis.estimated_boxes_per_day} caixas/dia</span>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                // Actualizar m√©tricas si es hot lead
                if (score >= 7) {
                    const currentHot = parseInt(document.getElementById('hotLeads').textContent);
                    document.getElementById('hotLeads').textContent = currentHot + 1;
                }
            }
            
            // Cambiar bot√≥n a completado
            btn.innerHTML = '<i class="fas fa-check mr-1"></i>Enriquecido!';
            btn.classList.remove('from-purple-600', 'to-indigo-600');
            btn.classList.add('bg-green-600');
            
            // Actualizar contador de cr√©ditos
            totalCreditsUsed += 2; // Apollo + Lusha
            updateCreditCounter();
            
            // Actualizar m√©tricas
            const currentEnriched = parseInt(document.getElementById('enrichedCount').textContent);
            document.getElementById('enrichedCount').textContent = currentEnriched + 1;
            
            if (enriched.phone) {
                const currentWithPhone = parseInt(document.getElementById('withPhone').textContent);
                document.getElementById('withPhone').textContent = currentWithPhone + 1;
            }
            
        } catch (error) {
            console.error('Error enriqueciendo:', error);
            const contactId = JSON.parse(atob(encodedContact)).id || JSON.parse(atob(encodedContact)).name.replace(/\s/g, '_');
            const btn = document.getElementById(`enrich-btn-${contactId}`);
            btn.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i>Error';
            btn.classList.add('bg-red-600');
        }
    }
    
    // Agregar contador de cr√©ditos en la UI
    function updateCreditCounter() {
        let counterDiv = document.getElementById('creditCounter');
        if (!counterDiv) {
            // Crear el contador si no existe
            const nav = document.querySelector('nav .flex.gap-2');
            counterDiv = document.createElement('div');
            counterDiv.id = 'creditCounter';
            counterDiv.className = 'ml-4 bg-yellow-500 px-3 py-1 rounded-full text-white text-xs font-bold';
            nav.appendChild(counterDiv);
        }
        counterDiv.innerHTML = `üí≥ ${totalCreditsUsed} cr√©ditos usados`;
    }
    
    // Mapeo de sectores a palabras clave para Apollo
    const SECTOR_KEYWORDS = {
        'high_volume': ['ecommerce', 'e-commerce', 'fulfillment', 'marketplace', 'logistics', '3pl', 'warehouse'],
        'manufacturing': ['manufacturing', 'industrial', 'factory', 'production', 'food', 'beverage', 'pharmaceutical'],
        'automotive': ['automotive', 'auto parts', 'autope√ßas', 'vehicle', 'car manufacturer'],
        'retail': ['retail', 'wholesale', 'distribution', 'varejo', 'atacado', 'distribui√ß√£o'],
        'textil': ['textile', 'clothing', 'fashion', 'apparel', 't√™xtil', 'vestu√°rio', 'moda'],
        'cosmetics': ['cosmetics', 'beauty', 'personal care', 'cosm√©ticos', 'beleza']
    };

    // Funci√≥n principal de b√∫squeda v2
    async function searchProspectsV2() {
        const sector = document.getElementById('sectorFilter').value;
        const size = document.getElementById('sizeFilter').value;
        const location = document.getElementById('locationFilter').value;
        const titlePriority = document.getElementById('titlePriority').value;
        const searchMode = document.getElementById('searchMode').value;
        
        // Reset
        allProspects = [];
        enrichedData.clear();
        companiesData.clear();
        updateMetrics();
        
        // Mostrar progreso
        showProgress('Buscando empresas relevantes no setor...');
        
        try {
            // Paso 1: Buscar empresas por sector
            const companies = await searchCompaniesBySector(sector, size, location);
            updateProgress(20, `${companies.length} empresas encontradas. Buscando decisores...`);
            
            // Paso 2: Buscar contactos relevantes en esas empresas
            let contacts = [];
            for (const company of companies.slice(0, 10)) { // Limitar a 10 empresas top
                const companyContacts = await findContactsInCompany(company, titlePriority);
                contacts = contacts.concat(companyContacts);
                updateProgress(20 + (contacts.length * 2), `${contacts.length} contatos identificados...`);
            }
            
            // Paso 3: NO enriquecer autom√°ticamente - esperar decisi√≥n del usuario
            // Los contactos se mostrar√°n primero con LinkedIn para revisi√≥n manual
            
            // Paso 4: An√°lisis b√°sico r√°pido sin gastar cr√©ditos
            updateProgress(90, 'Preparando resultados...');
            
            // Mostrar resultados
            allProspects = contacts;
            displayResultsV2(contacts);
            hideProgress();
            
        } catch (error) {
            console.error('Erro na busca:', error);
            hideProgress();
            showError('Erro ao buscar prospectos. Verifique console para detalhes.');
        }
    }

    // Buscar empresas por sector
    async function searchCompaniesBySector(sector, size, location) {
        const keywords = SECTOR_KEYWORDS[sector] || SECTOR_KEYWORDS['all'];
        
        const response = await fetch('/api/apollo-search-companies', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                industries: keywords,
                size_range: size,
                location: location
            })
        });
        
        const data = await response.json();
        return data.companies || [];
    }

    // Buscar contactos en una empresa espec√≠fica
    async function findContactsInCompany(company, titlePriority) {
        let titles = [];
        
        switch(titlePriority) {
            case 'operations_first':
                titles = ['Operations Manager', 'Logistics Manager', 'Supply Chain Manager', 'COO'];
                break;
            case 'quality_first':
                titles = ['Quality Manager', 'Production Manager', 'Plant Manager'];
                break;
            case 'c_level':
                titles = ['COO', 'CEO', 'Operations Director', 'VP Operations'];
                break;
            default:
                titles = ['Manager', 'Director', 'Gerente', 'Diretor'];
        }
        
        const response = await fetch('/api/apollo-find-contacts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                company_name: company.name,
                company_domain: company.domain,
                titles: titles
            })
        });
        
        const data = await response.json();
        const contacts = data.contacts || [];
        
        // Agregar informaci√≥n de la empresa a cada contacto
        return contacts.map(contact => ({
            ...contact,
            company: company,
            company_employees: company.estimated_num_employees,
            company_industry: company.industry
        }));
    }

    // Enriquecer contacto con Apollo y Lusha
    async function enrichContact(contact, index) {
        const enriched = {
            ...contact,
            apollo_data: null,
            lusha_data: null,
            serper_data: null
        };
        
        // Apollo enrich
        try {
            const apolloResp = await fetch('/api/apollo-enrich-fixed', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    person: contact,
                    first_name: contact.first_name,
                    last_name: contact.last_name,
                    company_name: contact.company?.name
                })
            });
            const apolloData = await apolloResp.json();
            if (apolloData.success) {
                enriched.apollo_data = apolloData.person;
                enriched.email = apolloData.person?.email || contact.email;
                enriched.phone = apolloData.person?.phone_numbers?.[0]?.number;
            }
        } catch (e) {
            console.log('Apollo enrich failed:', e);
        }
        
        // Lusha enrich si no hay tel√©fono
        if (!enriched.phone) {
            try {
                const lushaResp = await fetch('/api/lusha-enrich', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        firstName: contact.first_name,
                        lastName: contact.last_name,
                        company: contact.company?.name,
                        linkedinUrl: contact.linkedin_url
                    })
                });
                const lushaData = await lushaResp.json();
                if (lushaData.enriched) {
                    enriched.lusha_data = lushaData.contact;
                    enriched.phone = enriched.phone || lushaData.contact?.phone;
                    enriched.email = enriched.email || lushaData.contact?.email;
                }
            } catch (e) {
                console.log('Lusha enrich failed:', e);
            }
        }
        
        // Serper - buscar informaci√≥n √∫til de la empresa
        try {
            const serperResp = await fetch('/api/serper-company-intel', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    company_name: contact.company?.name,
                    queries: [
                        `"${contact.company?.name}" "centro de distribui√ß√£o" OR "f√°brica" OR "unidade"`,
                        `"${contact.company?.name}" "volume de produ√ß√£o" OR "capacidade" OR "caixas por dia"`,
                        `"${contact.company?.name}" "problemas" OR "recall" OR "log√≠stica"`
                    ]
                })
            });
            const serperData = await serperResp.json();
            enriched.serper_data = serperData;
        } catch (e) {
            console.log('Serper failed:', e);
        }
        
        enrichedData.set(contact.id || `${contact.first_name}_${contact.last_name}`, enriched);
        return enriched;
    }

    // An√°lisis con Claude mejorado
    async function analyzeProspect(contact, index) {
        const enriched = enrichedData.get(contact.id || `${contact.first_name}_${contact.last_name}`) || contact;
        
        const response = await fetch('/api/claude-analyze-v2', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contact: enriched,
                company: contact.company,
                enrichment_data: {
                    apollo: enriched.apollo_data,
                    lusha: enriched.lusha_data,
                    serper: enriched.serper_data
                }
            })
        });
        
        const analysis = await response.json();
        enriched.analysis = analysis;
        enriched.score = analysis.total_score || 0;
        
        return analysis;
    }

    // Mostrar resultados v2
    function displayResultsV2(prospects) {
        const resultsDiv = document.getElementById('results');
        
        if (prospects.length === 0) {
            resultsDiv.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma empresa relevante encontrada</p>';
            return;
        }
        
        let html = '<div class="space-y-6">';
        
        // Agrupar por empresa
        const companiesMap = new Map();
        prospects.forEach(p => {
            const companyName = p.company?.name || 'Empresa n√£o identificada';
            if (!companiesMap.has(companyName)) {
                companiesMap.set(companyName, []);
            }
            companiesMap.get(companyName).push(p);
        });
        
        // Mostrar por empresa
        companiesMap.forEach((contacts, companyName) => {
            const company = contacts[0]?.company || {};
            const enriched = enrichedData.get(contacts[0]?.id) || {};
            
            html += `
                <div class="border-2 border-gray-200 rounded-xl overflow-hidden">
                    <!-- Header da empresa mejorado con m√°s informaci√≥n visible -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 border-b">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-gray-800">${companyName}</h3>
                                <div class="flex gap-4 mt-2 text-sm">
                                    <span><i class="fas fa-industry mr-1"></i>${company.industry || 'Setor n√£o identificado'}</span>
                                    <span><i class="fas fa-users mr-1"></i>${company.estimated_num_employees || '?'} funcion√°rios</span>
                                    <span><i class="fas fa-map-marker-alt mr-1"></i>${company.location || 'Brasil'}</span>
                                    ${company.website ? `<a href="${company.website}" target="_blank" class="text-blue-600 hover:text-blue-800"><i class="fas fa-globe mr-1"></i>Website</a>` : ''}
                                </div>
                                ${company.description ? `
                                    <div class="mt-2 text-xs text-gray-600 italic">
                                        ${company.description.substring(0, 200)}${company.description.length > 200 ? '...' : ''}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-indigo-600">
                                    ${estimateBoxesPerDay(company)}
                                </div>
                                <div class="text-xs text-gray-600">caixas/dia estimado</div>
                                <div class="mt-2">
                                    <span class="px-2 py-1 ${parseInt(estimateBoxesPerDay(company)) > 1000 ? 'bg-green-500' : parseInt(estimateBoxesPerDay(company)) > 500 ? 'bg-yellow-500' : 'bg-gray-500'} text-white rounded-full text-xs">
                                        ${parseInt(estimateBoxesPerDay(company)) > 1000 ? 'Alto Potencial' : parseInt(estimateBoxesPerDay(company)) > 500 ? 'M√©dio Potencial' : 'Baixo Potencial'}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        ${enriched.serper_data?.insights ? `
                            <div class="mt-3 p-3 bg-white rounded-lg">
                                <p class="text-sm font-semibold mb-1">üìä Intelig√™ncia de Mercado:</p>
                                <p class="text-xs text-gray-700">${enriched.serper_data.insights}</p>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Contatos da empresa -->
                    <div class="p-4">
                        <p class="text-sm font-semibold mb-3">Decisores Identificados:</p>
                        <div class="grid grid-cols-2 gap-3">
                            ${contacts.map(contact => {
                                const enriched = enrichedData.get(contact.id) || contact;
                                const score = enriched.analysis?.total_score || 0;
                                
                                return `
                                    <div class="border rounded-lg p-3 hover:shadow-md transition-all" id="contact-${contact.id || contact.name.replace(/\s/g, '_')}">
                                        <div class="flex justify-between items-start">
                                            <div class="flex-1">
                                                <p class="font-semibold">${contact.name}</p>
                                                <p class="text-sm text-gray-600">${contact.title}</p>
                                                
                                                <!-- LinkedIn siempre visible primero para revisi√≥n -->
                                                <div class="mt-2 space-y-1 text-xs">
                                                    ${contact.linkedin_url ? `
                                                        <div class="flex items-center gap-2">
                                                            <a href="${contact.linkedin_url}" target="_blank" class="text-blue-600 hover:text-blue-800 font-semibold">
                                                                <i class="fab fa-linkedin mr-1"></i>Ver LinkedIn Primeiro
                                                            </a>
                                                            <span class="text-gray-400">‚Üê Revise antes de enriquecer</span>
                                                        </div>
                                                    ` : '<div class="text-red-400"><i class="fas fa-exclamation-triangle mr-1"></i>Sem LinkedIn dispon√≠vel</div>'}
                                                    
                                                    <!-- Mostrar datos si ya fueron enriquecidos -->
                                                    <div id="contact-data-${contact.id || contact.name.replace(/\s/g, '_')}" class="mt-2">
                                                        ${enriched.email ? `
                                                            <div class="text-green-600">
                                                                <i class="fas fa-check-circle mr-1"></i>
                                                                ${enriched.email}
                                                            </div>
                                                        ` : '<div class="text-gray-400"><i class="fas fa-envelope mr-1"></i>Email n√£o revelado</div>'}
                                                        
                                                        ${enriched.phone ? `
                                                            <div class="text-green-600">
                                                                <i class="fas fa-check-circle mr-1"></i>
                                                                ${enriched.phone}
                                                            </div>
                                                        ` : '<div class="text-gray-400"><i class="fas fa-phone mr-1"></i>Telefone n√£o revelado</div>'}
                                                    </div>
                                                </div>
                                                
                                                <!-- √Årea de an√°lisis que se llena despu√©s -->
                                                <div id="analysis-${contact.id || contact.name.replace(/\s/g, '_')}" class="mt-3"></div>
                                            </div>
                                        </div>
                                        
                                        <!-- Botones de acci√≥n -->
                                        <div class="mt-3 flex gap-2">
                                            ${contact.linkedin_url ? `
                                                <button onclick="enrichThisContact('${btoa(JSON.stringify(contact))}')" 
                                                        class="px-3 py-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded text-xs hover:from-purple-700 hover:to-indigo-700 w-full font-semibold"
                                                        id="enrich-btn-${contact.id || contact.name.replace(/\s/g, '_')}">
                                                    <i class="fas fa-search-dollar mr-1"></i>Enriquecer (gastar cr√©ditos)
                                                </button>
                                            ` : `
                                                <button disabled 
                                                        class="px-3 py-1 bg-gray-300 text-gray-500 rounded text-xs w-full cursor-not-allowed">
                                                    <i class="fas fa-times mr-1"></i>Sem LinkedIn
                                                </button>
                                            `}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        resultsDiv.innerHTML = html;
        updateMetrics();
    }

    // Estimar cajas por d√≠a basado en empleados y sector
    function estimateBoxesPerDay(company) {
        const employees = company.estimated_num_employees || 100;
        const industry = (company.industry || '').toLowerCase();
        
        let multiplier = 1;
        
        // Multiplicador por industria
        if (industry.includes('ecommerce') || industry.includes('fulfillment')) {
            multiplier = 3;
        } else if (industry.includes('food') || industry.includes('beverage')) {
            multiplier = 2.5;
        } else if (industry.includes('pharmaceutical') || industry.includes('cosmetic')) {
            multiplier = 2;
        } else if (industry.includes('manufacturing')) {
            multiplier = 1.5;
        }
        
        // C√°lculo base: 1 caja por cada 10 empleados por d√≠a
        const baseBoxes = Math.round((employees / 10) * multiplier);
        
        // Formatear n√∫mero
        if (baseBoxes > 1000) {
            return `${(baseBoxes / 1000).toFixed(1)}k`;
        }
        return baseBoxes.toString();
    }

    // Funciones de utilidad
    function showProgress(text) {
        document.getElementById('searchProgress').classList.remove('hidden');
        document.getElementById('progressText').textContent = text;
        document.getElementById('progressBar').style.width = '10%';
    }

    function updateProgress(percent, text) {
        document.getElementById('progressText').textContent = text;
        document.getElementById('progressBar').style.width = `${percent}%`;
    }

    function hideProgress() {
        document.getElementById('searchProgress').classList.add('hidden');
    }

    function showError(message) {
        document.getElementById('results').innerHTML = `
            <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
                <p>${message}</p>
            </div>
        `;
    }

    function updateMetrics() {
        const companiesCount = new Set(allProspects.map(p => p.company?.name)).size;
        const withPhone = allProspects.filter(p => {
            const e = enrichedData.get(p.id) || p;
            return e.phone;
        }).length;
        const hotLeads = allProspects.filter(p => {
            const e = enrichedData.get(p.id) || p;
            return e.analysis?.total_score >= 7;
        }).length;
        
        document.getElementById('companiesFound').textContent = companiesCount;
        document.getElementById('contactsFound').textContent = allProspects.length;
        document.getElementById('enrichedCount').textContent = enrichedData.size;
        document.getElementById('withPhone').textContent = withPhone;
        document.getElementById('hotLeads').textContent = hotLeads;
        
        // Calcular total de cajas estimadas
        let totalBoxes = 0;
        new Set(allProspects.map(p => p.company?.name)).forEach(companyName => {
            const company = allProspects.find(p => p.company?.name === companyName)?.company;
            if (company) {
                const boxes = parseInt(estimateBoxesPerDay(company).replace('k', '000')) || 0;
                totalBoxes += boxes;
            }
        });
        document.getElementById('estimatedBoxes').textContent = totalBoxes > 1000 ? `${(totalBoxes/1000).toFixed(1)}k` : totalBoxes;
    }

    function copyContact(email, phone) {
        const text = `Email: ${email || 'N√£o dispon√≠vel'}\nTelefone: ${phone || 'N√£o dispon√≠vel'}`;
        navigator.clipboard.writeText(text);
        
        // Feedback visual
        event.target.innerHTML = '<i class="fas fa-check mr-1"></i>Copiado!';
        setTimeout(() => {
            event.target.innerHTML = '<i class="fas fa-copy mr-1"></i>Copiar';
        }, 2000);
    }

    function saveContact(encodedData) {
        try {
            const data = JSON.parse(atob(encodedData));
            
            // Aqu√≠ podr√≠as hacer una llamada a tu API para guardar en base de datos
            // Por ahora lo guardamos en localStorage
            const saved = JSON.parse(localStorage.getItem('ventapel_contacts') || '[]');
            saved.push({
                ...data,
                saved_at: new Date().toISOString()
            });
            localStorage.setItem('ventapel_contacts', JSON.stringify(saved));
            
            event.target.innerHTML = '<i class="fas fa-check mr-1"></i>Salvo!';
            setTimeout(() => {
                event.target.innerHTML = '<i class="fas fa-save mr-1"></i>Salvar';
            }, 2000);
        } catch (e) {
            console.error('Erro ao salvar:', e);
        }
    }

    function exportEnhancedCSV() {
        if (allProspects.length === 0) {
            alert('Nenhum dado para exportar');
            return;
        }
        
        const BOM = '\uFEFF';
        let csvContent = BOM + "Empresa,Setor,Funcion√°rios,Caixas/Dia Est.,Nome,Cargo,Email,Telefone,LinkedIn,Score PPVVC,Pain,Power,Vision,Value,Control,Compras,An√°lise,Potencial\n";
        
        allProspects.forEach(prospect => {
            const enriched = enrichedData.get(prospect.id) || prospect;
            const analysis = enriched.analysis || {};
            const scores = analysis.scores || {};
            
            const row = [
                prospect.company?.name || '',
                prospect.company?.industry || '',
                prospect.company?.estimated_num_employees || '',
                estimateBoxesPerDay(prospect.company || {}),
                prospect.name || '',
                prospect.title || '',
                enriched.email || '',
                enriched.phone || '',
                prospect.linkedin_url || '',
                analysis.total_score || '0',
                scores.pain || '0',
                scores.power || '0',
                scores.vision || '0',
                scores.value || '0',
                scores.control || '0',
                scores.compras || '0',
                analysis.key_insight || '',
                analysis.total_score >= 7 ? 'HOT' : analysis.total_score >= 5 ? 'WARM' : 'COLD'
            ].map(field => `"${String(field).replace(/"/g, '""')}"`).join(',');
            
            csvContent += row + "\n";
        });
        
        // Agregar resumen al final
        csvContent += "\n\n--- RESUMO ---\n";
        csvContent += `Total de empresas:,${new Set(allProspects.map(p => p.company?.name)).size}\n`;
        csvContent += `Total de contatos:,${allProspects.length}\n`;
        csvContent += `Hot Leads:,${allProspects.filter(p => (enrichedData.get(p.id)?.analysis?.total_score || 0) >= 7).length}\n`;
        csvContent += `Com telefone:,${allProspects.filter(p => enrichedData.get(p.id)?.phone).length}\n`;
        csvContent += `Com email:,${allProspects.filter(p => enrichedData.get(p.id)?.email).length}\n`;
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `ventapel_prospects_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
    }

    function sortByScore() {
        allProspects.sort((a, b) => {
            const scoreA = enrichedData.get(a.id)?.analysis?.total_score || 0;
            const scoreB = enrichedData.get(b.id)?.analysis?.total_score || 0;
            return scoreB - scoreA;
        });
        displayResultsV2(allProspects);
    }

    function filterHotOnly() {
        const hotProspects = allProspects.filter(p => {
            const score = enrichedData.get(p.id)?.analysis?.total_score || 0;
            return score >= 7;
        });
        displayResultsV2(hotProspects);
    }

    function clearResults() {
        allProspects = [];
        enrichedData.clear();
        companiesData.clear();
        document.getElementById('results').innerHTML = `
            <p class="text-gray-500 text-center py-8">
                <i class="fas fa-search text-4xl text-gray-300 mb-3 block"></i>
                Selecione os filtros e clique em buscar
            </p>
        `;
        updateMetrics();
    }

    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', () => {
        updateMetrics();
    });
    </script>
</body>
</html>
