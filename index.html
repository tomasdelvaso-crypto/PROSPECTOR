<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ventapel Prospector Pro - Sistema Company-First</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <nav class="bg-gradient-to-r from-blue-900 to-indigo-800 shadow-xl">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-5">
                <div>
                    <h1 class="text-3xl font-bold text-white">Ventapel Prospector Pro</h1>
                    <p class="text-sm text-blue-200">Company-First Intelligence System</p>
                </div>
                <div class="flex gap-2">
                    <span class="bg-green-500 px-3 py-1 rounded-full text-white text-xs font-semibold">Apollo.io</span>
                    <span class="bg-yellow-500 px-3 py-1 rounded-full text-white text-xs font-semibold">Lusha</span>
                    <span class="bg-purple-500 px-3 py-1 rounded-full text-white text-xs font-semibold">Serper</span>
                    <span class="bg-red-500 px-3 py-1 rounded-full text-white text-xs font-semibold">Claude AI</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        
        <!-- Workflow Steps Indicator -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-8">
                    <div class="flex items-center" id="step1-indicator">
                        <div class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold">1</div>
                        <span class="ml-2 font-semibold">Buscar Empresas & Decisores</span>
                    </div>
                    <div class="text-gray-400">‚Üí</div>
                    <div class="flex items-center opacity-50" id="step2-indicator">
                        <div class="w-10 h-10 bg-gray-300 text-white rounded-full flex items-center justify-center font-bold">2</div>
                        <span class="ml-2 font-semibold text-gray-500">An√°lise Profunda</span>
                    </div>
                </div>
                <div id="credits-counter" class="text-sm text-gray-600">
                    <i class="fas fa-coins mr-1"></i>
                    <span id="credits-used">0</span> cr√©ditos usados
                </div>
            </div>
        </div>

        <!-- Step 1: Company Search -->
        <div id="step1-panel" class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">
                <i class="fas fa-building mr-2 text-blue-600"></i>
                Buscar Empresas & Decisores
            </h2>
            
            <!-- Toggle para modo de b√∫squeda -->
            <div class="flex gap-3 mb-4 p-3 bg-blue-50 rounded-lg">
                <button id="searchByFilters" onclick="toggleSearchMode('filters')" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold transition-all duration-200">
                    <i class="fas fa-filter mr-2"></i>Busca por Filtros
                </button>
                <button id="searchByName" onclick="toggleSearchMode('name')" 
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold transition-all duration-200">
                    <i class="fas fa-search mr-2"></i>Busca por Nome da Empresa
                </button>
            </div>
            
            <!-- Panel de b√∫squeda por nombre -->
            <div id="nameSearchPanel" class="hidden mb-4">
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                    <p class="text-sm text-yellow-800">
                        <i class="fas fa-info-circle mr-2"></i>
                        Digite o nome da empresa. A busca encontrar√° empresas que contenham o texto digitado.
                    </p>
                </div>
                <div class="flex gap-3">
                    <input type="text" 
                           id="companyNameInput"
                           placeholder="Ex: Lojas Americanas, Magazine Luiza, B2W..."
                           class="flex-1 p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                    <button onclick="searchByCompanyName()" 
                            class="px-6 py-3 bg-gradient-to-r from-green-600 to-teal-600 text-white rounded-lg hover:from-green-700 hover:to-teal-700 font-semibold shadow-lg transition-all duration-200 transform hover:scale-105">
                        <i class="fas fa-building-circle-check mr-2"></i>Buscar Empresa
                    </button>
                </div>
            </div>
            
            <!-- Panel de filtros tradicionales -->
            <div id="filtersPanel">
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-semibold mb-1 text-gray-700">
                            üè≠ Ind√∫stria Vertical
                        </label>
                        <select id="industryFilter" 
                                class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                            <option value="logistica" selected>Log√≠stica e Transporte</option>
                            <option value="ecommerce">E-commerce e Varejo</option>
                            <option value="manufactura">Manufactura e Ind√∫stria</option>
                            <option value="alimentos">Alimentos e Bebidas</option>
                            <option value="automotriz">Automotriz e Autope√ßas</option>
                            <option value="farma_cosmetica">Farmac√™utica e Cosm√©tica</option>
                            <option value="textil">T√™xtil e Vestu√°rio</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-1 text-gray-700">
                            üìç Localiza√ß√£o
                        </label>
                        <select id="locationFilter" 
                                class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                            <option value="Brazil">Brasil (Todo)</option>
                            <option value="S√£o Paulo, Brazil">S√£o Paulo</option>
                            <option value="Rio de Janeiro, Brazil">Rio de Janeiro</option>
                            <option value="Santa Catarina, Brazil" selected>Santa Catarina</option>
                            <option value="Rio Grande do Sul, Brazil">Rio Grande do Sul</option>
                            <option value="Paran√°, Brazil">Paran√°</option>
                            <option value="Minas Gerais, Brazil">Minas Gerais</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-1 text-gray-700">
                            üë• Porte (Funcion√°rios)
                        </label>
                        <select id="sizeFilter" 
                                class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                            <option value="">Todos os Portes</option>
                            <option value="100,500">100-500</option>
                            <option value="501,1000" selected>501-1000</option>
                            <option value="1001,5000">1001-5000</option>
                            <option value="5001,10000">5001+</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="searchCompaniesWithContacts()" 
                            class="px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:from-blue-700 hover:to-indigo-700 font-semibold shadow-lg transition-all duration-200 transform hover:scale-105">
                        <i class="fas fa-search mr-2"></i>Buscar Empresas com Decisores
                    </button>
                </div>
            </div>
            
            <!-- Botones generales -->
            <div class="flex gap-3 mt-4">
                <button onclick="clearAll()" 
                        class="px-4 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-all duration-200">
                    <i class="fas fa-eraser mr-2"></i>Limpar
                </button>
                
                <button onclick="exportResults()" 
                        class="px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all duration-200">
                    <i class="fas fa-download mr-2"></i>Exportar CSV
                </button>
            </div>
        </div>

        <!-- Companies Results with Pagination -->
        <div id="companies-container" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">
                        Mostrando <span id="companies-showing">0</span> de <span id="companies-total">0</span> empresas
                    </h3>
                    <div class="text-sm text-gray-600">
                        P√°gina <span id="current-page">1</span> de <span id="total-pages">1</span>
                    </div>
                </div>
                <div id="companies-list" class="space-y-4">
                    <!-- Companies will be inserted here -->
                </div>
                
                <!-- Pagination Controls -->
                <div class="flex justify-center gap-3 mt-6">
                    <button onclick="previousPage()" 
                            id="prev-btn"
                            class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
                        <i class="fas fa-chevron-left mr-2"></i>Anterior
                    </button>
                    <button onclick="nextPage()" 
                            id="next-btn"
                            class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
                        Pr√≥xima<i class="fas fa-chevron-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading States -->
        <div id="loading-companies" class="hidden">
            <div class="bg-blue-50 rounded-lg p-8 text-center">
                <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
                <p class="text-lg font-semibold text-blue-800" id="loading-text">Buscando empresas e decisores qualificados...</p>
                <p class="text-sm text-blue-600 mt-2">Isso pode levar alguns segundos</p>
            </div>
        </div>
    </div>

    <!-- Modal for Contact Analysis -->
    <div id="contactModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto m-4">
            <div class="sticky top-0 bg-white border-b p-4 flex justify-between items-center">
                <h3 class="text-xl font-bold">An√°lise de Decisor</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div id="modal-content" class="p-6">
                <!-- Contact details will be inserted here -->
            </div>
        </div>
    </div>

<script>
// Mapeo de industrias a palabras clave para Apollo
const INDUSTRY_MAPPING = {
    logistica: ["logistics", "transportation", "freight", "supply chain", "warehouse", "fulfillment", "distribution"],
    ecommerce: ["ecommerce", "retail", "marketplace", "online retail"],
    manufactura: ["manufacturing", "industrial", "machinery", "plastics"],
    alimentos: ["food & beverages", "food production", "agribusiness"],
    automotriz: ["automotive", "auto parts", "motor vehicle manufacturing"],
    farma_cosmetica: ["pharmaceuticals", "cosmetics", "biotechnology"],
    textil: ["textiles", "apparel & fashion", "footwear"]
};

// Global state
let currentCompanies = [];
let currentContacts = {};
let creditsUsed = 0;
let analysisResults = {};
let currentPageNum = 1;
let totalPages = 1;
let totalCompanies = 0;
let currentSearchMode = 'filters';
let lastSearchParams = null;

// Toggle entre modos de b√∫squeda
function toggleSearchMode(mode) {
    currentSearchMode = mode;
    const filtersPanel = document.getElementById('filtersPanel');
    const namePanel = document.getElementById('nameSearchPanel');
    const filterBtn = document.getElementById('searchByFilters');
    const nameBtn = document.getElementById('searchByName');
    
    if (mode === 'name') {
        filtersPanel.classList.add('hidden');
        namePanel.classList.remove('hidden');
        filterBtn.classList.remove('bg-blue-600', 'text-white');
        filterBtn.classList.add('bg-gray-200', 'text-gray-700');
        nameBtn.classList.remove('bg-gray-200', 'text-gray-700');
        nameBtn.classList.add('bg-green-600', 'text-white');
    } else {
        filtersPanel.classList.remove('hidden');
        namePanel.classList.add('hidden');
        filterBtn.classList.remove('bg-gray-200', 'text-gray-700');
        filterBtn.classList.add('bg-blue-600', 'text-white');
        nameBtn.classList.remove('bg-green-600', 'text-white');
        nameBtn.classList.add('bg-gray-200', 'text-gray-700');
    }
}

// B√∫squeda por nombre de empresa
async function searchByCompanyName(page = 1) {
    const companyName = document.getElementById('companyNameInput').value.trim();
    
    if (!companyName) {
        alert('Por favor, digite o nome da empresa');
        return;
    }
    
    const loadingDiv = document.getElementById('loading-companies');
    const companiesContainer = document.getElementById('companies-container');
    const loadingText = document.getElementById('loading-text');
    
    loadingText.textContent = `Buscando "${companyName}" no banco de dados...`;
    loadingDiv.classList.remove('hidden');
    companiesContainer.classList.add('hidden');
    
    currentPageNum = page;
    
    // Guardar par√°metros para paginaci√≥n
    lastSearchParams = {
        type: 'name',
        companyName: companyName
    };
    
    try {
        const response = await fetch('/api/1-search-company-by-name', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                companyName,
                page
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentCompanies = data.organizations || [];
            totalCompanies = data.total || 0;
            totalPages = data.total_pages || 1;
            
            // Store contacts in global object
            currentCompanies.forEach((company, idx) => {
                currentContacts[idx] = company.contacts || [];
            });
            
            if (currentCompanies.length === 0) {
                displayNoResults(companyName);
            } else {
                displayCompaniesWithContacts(currentCompanies);
            }
            
            updatePaginationControls();
        } else {
            alert(`Erro na busca: ${data.error || 'Erro desconhecido'}`);
        }
        
    } catch (error) {
        console.error('Error searching company by name:', error);
        alert('Erro ao buscar empresa. Verifique o console.');
    } finally {
        loadingDiv.classList.add('hidden');
    }
}

// Mostrar cuando no hay resultados
function displayNoResults(searchTerm) {
    const container = document.getElementById('companies-container');
    const listDiv = document.getElementById('companies-list');
    
    listDiv.innerHTML = `
        <div class="text-center py-12">
            <i class="fas fa-search-minus text-6xl text-gray-300 mb-4"></i>
            <p class="text-xl text-gray-700 mb-2">Nenhuma empresa encontrada para:</p>
            <p class="text-lg font-semibold text-gray-900">"${searchTerm}"</p>
            <div class="mt-6 text-sm text-gray-600">
                <p>Sugest√µes:</p>
                <ul class="mt-2 space-y-1">
                    <li>‚Ä¢ Verifique a ortografia</li>
                    <li>‚Ä¢ Tente um nome mais curto ou parcial</li>
                    <li>‚Ä¢ Use apenas o nome principal (sem "Ltda", "S.A.", etc)</li>
                </ul>
            </div>
        </div>
    `;
    
    container.classList.remove('hidden');
}

// Utility functions
function estimateBoxesPerDay(company) {
    const employees = company.estimated_num_employees || 100;
    const industry = (company.industry || '').toLowerCase();
    
    let multiplier = 1;
    if (industry.includes('logistics') || industry.includes('fulfillment') || industry.includes('ecommerce')) {
        multiplier = 3;
    } else if (industry.includes('manufacturing') || industry.includes('food')) {
        multiplier = 2;
    }
    
    return Math.round((employees / 10) * multiplier);
}

function updateStepIndicator(step) {
    for (let i = 1; i <= 2; i++) {
        const indicator = document.getElementById(`step${i}-indicator`);
        if (indicator && i <= step) {
            indicator.classList.remove('opacity-50');
            indicator.querySelector('div').classList.remove('bg-gray-300');
            indicator.querySelector('div').classList.add('bg-blue-600');
            indicator.querySelector('span').classList.remove('text-gray-500');
        }
    }
}

function closeModal() {
    document.getElementById('contactModal').classList.add('hidden');
}

function clearAll() {
    currentCompanies = [];
    currentContacts = {};
    analysisResults = {};
    creditsUsed = 0;
    currentPageNum = 1;
    totalPages = 1;
    totalCompanies = 0;
    lastSearchParams = null;
    document.getElementById('companies-container').classList.add('hidden');
    document.getElementById('credits-used').textContent = '0';
    document.getElementById('companyNameInput').value = '';
    updateStepIndicator(1);
}

function exportResults() {
    if (Object.keys(analysisResults).length === 0) {
        alert('Nenhuma an√°lise para exportar');
        return;
    }
    
    let csv = 'Empresa,Contato,Cargo,Email,Telefone,Score PPVVC,Prioridade,Abordagem\n';
    
    Object.values(analysisResults).forEach(result => {
        csv += `"${result.company.name}","${result.contact.name}","${result.contact.title || ''}","${result.contact.email || ''}","${result.contact.phone || ''}","${result.analysis.total_score}","${result.analysis.priority}","${result.analysis.approach || ''}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `ventapel_prospects_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

// Pagination functions
function updatePaginationControls() {
    document.getElementById('current-page').textContent = currentPageNum;
    document.getElementById('total-pages').textContent = totalPages;
    
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    
    prevBtn.disabled = currentPageNum <= 1;
    nextBtn.disabled = currentPageNum >= totalPages;
}

function previousPage() {
    if (currentPageNum > 1) {
        if (lastSearchParams?.type === 'name') {
            searchByCompanyName(currentPageNum - 1);
        } else {
            searchCompaniesWithContacts(currentPageNum - 1);
        }
    }
}

function nextPage() {
    if (currentPageNum < totalPages) {
        if (lastSearchParams?.type === 'name') {
            searchByCompanyName(currentPageNum + 1);
        } else {
            searchCompaniesWithContacts(currentPageNum + 1);
        }
    }
}

// Search Companies with Contacts - Updated to use industry mapping
async function searchCompaniesWithContacts(page = 1) {
    const loadingDiv = document.getElementById('loading-companies');
    const companiesContainer = document.getElementById('companies-container');
    const loadingText = document.getElementById('loading-text');
    
    loadingText.textContent = 'Buscando empresas e decisores qualificados...';
    loadingDiv.classList.remove('hidden');
    companiesContainer.classList.add('hidden');
    
    currentPageNum = page;
    
    // Get selected industry and map to keywords
    const selectedIndustry = document.getElementById('industryFilter').value;
    const keywords = INDUSTRY_MAPPING[selectedIndustry] || [];
    
    const filters = {
        keywords: keywords,
        location: document.getElementById('locationFilter').value,
        size: document.getElementById('sizeFilter').value
    };
    
    // Guardar par√°metros para paginaci√≥n
    lastSearchParams = {
        type: 'filters',
        filters: filters
    };
    
    console.log('Searching with industry:', selectedIndustry);
    console.log('Keywords being sent:', keywords);
    
    try {
        const response = await fetch('/api/1-search-companies-with-contacts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                filters,
                page
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentCompanies = data.organizations || [];
            totalCompanies = data.total || 0;
            totalPages = data.total_pages || 1;
            
            // Store contacts in global object
            currentCompanies.forEach((company, idx) => {
                currentContacts[idx] = company.contacts || [];
            });
            
            displayCompaniesWithContacts(currentCompanies);
            updatePaginationControls();
        }
        
    } catch (error) {
        console.error('Error searching companies:', error);
        alert('Erro ao buscar empresas. Verifique o console.');
    } finally {
        loadingDiv.classList.add('hidden');
    }
}

// Display companies with embedded contacts
function displayCompaniesWithContacts(companies) {
    const container = document.getElementById('companies-container');
    const listDiv = document.getElementById('companies-list');
    const showingSpan = document.getElementById('companies-showing');
    const totalSpan = document.getElementById('companies-total');
    
    if (companies.length === 0) {
        listDiv.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma empresa encontrada</p>';
        container.classList.remove('hidden');
        return;
    }
    
    showingSpan.textContent = companies.length;
    totalSpan.textContent = totalCompanies;
    
    let html = '';
    companies.forEach((company, idx) => {
        const boxesEstimate = estimateBoxesPerDay(company);
        const priority = boxesEstimate > 1000 ? 'HIGH' : boxesEstimate > 500 ? 'MEDIUM' : 'LOW';
        const priorityColor = priority === 'HIGH' ? 'green' : priority === 'MEDIUM' ? 'yellow' : 'gray';
        
        // Group contacts by department
        const contactsByDept = {};
        if (company.contacts && company.contacts.length > 0) {
            company.contacts.forEach(contact => {
                const dept = categorizeContact(contact.title);
                if (!contactsByDept[dept]) {
                    contactsByDept[dept] = [];
                }
                contactsByDept[dept].push(contact);
            });
        }
        
        html += `
            <div class="border rounded-lg p-4 hover:shadow-md transition-shadow" id="company-${idx}">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <h4 class="text-lg font-bold text-gray-800">${company.name}</h4>
                            <span class="px-2 py-1 bg-${priorityColor}-100 text-${priorityColor}-700 rounded-full text-xs font-semibold">
                                ${priority} - ~${boxesEstimate} caixas/dia
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 text-sm text-gray-600 mb-3">
                            <p><i class="fas fa-industry fa-fw mr-1"></i>${company.industry || 'N√£o especificado'}</p>
                            <p><i class="fas fa-users fa-fw mr-1"></i>${company.estimated_num_employees || 'N/A'} funcion√°rios</p>
                            <p><i class="fas fa-map-marker-alt fa-fw mr-1"></i>${company.city || company.state || 'Brasil'}</p>
                            <p><i class="fas fa-globe fa-fw mr-1"></i>
                                ${company.website_url ? `<a href="${company.website_url}" target="_blank" class="text-blue-600 hover:underline">${company.primary_domain}</a>` : 'N/A'}
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Embedded Contacts Grouped by Department -->
                <div class="border-t pt-3">
                    <p class="font-semibold mb-2 text-sm text-gray-700">
                        <i class="fas fa-user-tie mr-1"></i>
                        Decisores Encontrados (${company.contacts?.length || 0}):
                    </p>
                    ${Object.keys(contactsByDept).length > 0 ? 
                        Object.entries(contactsByDept).map(([dept, contacts]) => `
                            <div class="mb-3">
                                <p class="text-xs font-semibold text-gray-600 uppercase mb-1">${dept}</p>
                                <div class="grid grid-cols-2 lg:grid-cols-3 gap-2">
                                    ${contacts.map((contact, contactIdx) => {
                                        const originalIdx = company.contacts.indexOf(contact);
                                        return `
                                        <div class="border rounded-lg p-2 bg-gray-50 hover:bg-gray-100 transition-colors">
                                            <p class="font-semibold text-sm truncate">${contact.name}</p>
                                            <p class="text-xs text-gray-600 truncate mb-2">${contact.title || 'Cargo n√£o especificado'}</p>
                                            
                                            <div class="flex gap-1">
                                                ${contact.linkedin_url ? `
                                                    <a href="${contact.linkedin_url}" target="_blank" 
                                                       class="flex-1 px-2 py-1 bg-blue-600 text-white rounded text-xs text-center hover:bg-blue-700">
                                                        <i class="fab fa-linkedin"></i>
                                                    </a>
                                                ` : ''}
                                                <button onclick="window.openAnalysisModal('${idx}-${originalIdx}')" 
                                                        class="flex-1 px-2 py-1 bg-purple-600 text-white rounded text-xs hover:bg-purple-700 font-semibold">
                                                    <i class="fas fa-microscope mr-1"></i>Analisar
                                                </button>
                                            </div>
                                        </div>
                                    `}).join('')}
                                </div>
                            </div>
                        `).join('')
                    : '<p class="text-gray-500 text-sm">Nenhum decisor encontrado</p>'}
                </div>
            </div>
        `;
    });
    
    listDiv.innerHTML = html;
    container.classList.remove('hidden');
    updateStepIndicator(1);
}

// Categorize contact by department
function categorizeContact(title) {
    if (!title) return 'Outros';
    const titleLower = title.toLowerCase();
    
    if (titleLower.includes('operations') || titleLower.includes('opera√ß√£o') || titleLower.includes('operacional')) {
        return 'Opera√ß√µes';
    } else if (titleLower.includes('logistics') || titleLower.includes('log√≠stica') || titleLower.includes('supply chain')) {
        return 'Log√≠stica/Supply Chain';
    } else if (titleLower.includes('quality') || titleLower.includes('qualidade')) {
        return 'Qualidade';
    } else if (titleLower.includes('production') || titleLower.includes('produ√ß√£o') || titleLower.includes('plant') || titleLower.includes('planta')) {
        return 'Produ√ß√£o/Planta';
    } else if (titleLower.includes('procurement') || titleLower.includes('compras') || titleLower.includes('suprimentos') || titleLower.includes('purchasing')) {
        return 'Compras/Procurement';
    } else if (titleLower.includes('director') || titleLower.includes('diretor') || titleLower.includes('coo') || titleLower.includes('ceo')) {
        return 'Diretoria/C-Level';
    } else if (titleLower.includes('warehouse') || titleLower.includes('armaz√©m') || titleLower.includes('almoxarifado')) {
        return 'Armaz√©m/Warehouse';
    } else {
        return 'Outros';
    }
}

// Open modal for deep analysis
window.openAnalysisModal = function(uniqueId) {
    const [companyIdx, contactIdx] = uniqueId.split('-').map(Number);
    const company = currentCompanies[companyIdx];
    const contact = currentContacts[companyIdx][contactIdx];
    
    const modal = document.getElementById('contactModal');
    const content = document.getElementById('modal-content');
    
    content.innerHTML = `
        <div class="space-y-4">
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg">
                <h4 class="font-bold text-lg mb-2">${contact.name}</h4>
                <p class="text-gray-700">${contact.title}</p>
                <p class="text-sm text-gray-600">${company.name}</p>
            </div>
            
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                <p class="font-semibold text-yellow-800 mb-2">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    Antes de gastar cr√©ditos:
                </p>
                <a href="${contact.linkedin_url}" target="_blank" 
                   class="inline-block px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    <i class="fab fa-linkedin mr-2"></i>
                    Revisar Perfil no LinkedIn Primeiro
                </a>
            </div>
            
            <button onclick="window.performDeepAnalysis('${uniqueId}')" 
                    class="w-full px-6 py-3 bg-gradient-to-r from-purple-600 to-red-600 text-white rounded-lg hover:from-purple-700 hover:to-red-700 font-bold text-lg">
                <i class="fas fa-rocket mr-2"></i>
                Executar An√°lise Profunda (Gasta Cr√©ditos)
            </button>
            
            <div id="analysis-result-${uniqueId}" class="hidden"></div>
        </div>
    `;
    
    modal.classList.remove('hidden');
}

// Deep Analysis
window.performDeepAnalysis = async function(uniqueId) {
    const [companyIdx, contactIdx] = uniqueId.split('-').map(Number);
    const company = currentCompanies[companyIdx];
    const contact = currentContacts[companyIdx][contactIdx];
    
    const resultDiv = document.getElementById(`analysis-result-${uniqueId}`);
    resultDiv.classList.remove('hidden');
    resultDiv.innerHTML = `
        <div class="mt-4 p-4 bg-gray-100 rounded-lg">
            <div class="flex items-center">
                <i class="fas fa-spinner fa-spin text-2xl text-indigo-600 mr-3"></i>
                <div>
                    <p class="font-semibold" id="analysis-status">Iniciando an√°lise...</p>
                    <div class="w-64 bg-gray-200 rounded-full h-2 mt-2">
                        <div id="analysis-progress" class="bg-indigo-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    try {
        const updateProgress = (text, percent) => {
            document.getElementById('analysis-status').textContent = text;
            document.getElementById('analysis-progress').style.width = `${percent}%`;
        };
        
        // 1. Apollo Enrichment
        updateProgress('Enriquecendo com Apollo...', 25);
        
        const apolloRes = await fetch('/api/3-enrich-apollo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ person: contact })
        });
        const apolloData = await apolloRes.json();
        
        // 2. Lusha Enrichment
        updateProgress('Buscando telefone com Lusha...', 50);
        const enrichedContact = apolloData.person || contact;
        
        const lushaRes = await fetch('/api/3-enrich-lusha', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                person: enrichedContact,
                company: company.name
            })
        });
        const lushaData = await lushaRes.json();
        
        // 3. Serper Intel
        updateProgress('Coletando intelig√™ncia de mercado...', 75);
        
        const serperRes = await fetch('/api/3-intel-serper', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ company })
        });
        const serperData = await serperRes.json();
        
        // 4. Claude Analysis
        updateProgress('Analisando com IA...', 90);
        
        // Construir objeto de contato consolidado
        const consolidatedContact = {
            ...contact,
            ...enrichedContact,
            email: enrichedContact?.email || 
                   contact?.email ||
                   lushaData?.email ||
                   'N√£o dispon√≠vel',
            phone: lushaData?.phone || 
                   enrichedContact?.phone_numbers?.[0] ||
                   null
        };
        
        const claudeRes = await fetch('/api/4-analyze-claude', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                company,
                contact: consolidatedContact,
                intel: serperData
            })
        });
        const analysis = await claudeRes.json();
        
        // Store results
        analysisResults[uniqueId] = {
            company,
            contact: consolidatedContact,
            analysis,
            intel: serperData
        };
        
        // Update credits
        creditsUsed += 3;
        document.getElementById('credits-used').textContent = creditsUsed;
        
        // Display results
        window.displayAnalysisResults(uniqueId, analysisResults[uniqueId]);
        updateStepIndicator(2);
        
    } catch (error) {
        console.error('Erro na an√°lise:', error);
        
        resultDiv.innerHTML = `
            <div class="mt-4 p-4 bg-red-50 rounded-lg text-red-700">
                <i class="fas fa-exclamation-circle mr-2"></i>
                Erro na an√°lise: ${error.message}
                <br><small>Verifique o console para mais detalhes</small>
            </div>
        `;
    }
}

// Display analysis results
window.displayAnalysisResults = function(uniqueId, data) {
    const resultDiv = document.getElementById(`analysis-result-${uniqueId}`);
    const { contact, analysis, intel } = data;
    
    const email = contact.email || 'N√£o dispon√≠vel';
    const phone = contact.phone || null;
    
    // Procesar todos los tel√©fonos si vienen de Lusha
    const allPhones = contact.all_phones || [];
    const phoneSummary = contact.phone_summary || {};
    
    const score = analysis.total_score || 0;
    const priority = analysis.priority || 'COLD';
    const priorityColor = priority === 'HOT' ? 'red' : priority === 'WARM' ? 'yellow' : 'gray';
    
    // Generar HTML para todos los tel√©fonos
    let phonesHtml = '';
    if (allPhones && allPhones.length > 0) {
        phonesHtml = `
            <div class="mt-2 p-3 bg-blue-50 rounded">
                <p class="text-xs font-semibold text-blue-900 mb-2">
                    üì± ${allPhones.length} telefone${allPhones.length > 1 ? 's' : ''} encontrado${allPhones.length > 1 ? 's' : ''}:
                </p>
                <div class="space-y-1">
                    ${allPhones.map((p, idx) => {
                        const typeEmoji = p.type === 'mobile' ? 'üì±' : 
                                        p.type === 'direct' ? '‚òéÔ∏è' : 
                                        p.type === 'work' ? 'üè¢' : 'üìû';
                        const typeLabel = p.type === 'mobile' ? 'Celular' : 
                                        p.type === 'direct' ? 'Direto' : 
                                        p.type === 'work' ? 'Trabalho' : 'Outro';
                        const isPrimary = idx === 0;
                        
                        return `
                            <div class="flex items-center justify-between p-2 ${isPrimary ? 'bg-green-100 border border-green-300' : 'bg-white'} rounded">
                                <div class="flex items-center gap-2">
                                    <span>${typeEmoji}</span>
                                    <span class="font-semibold text-sm">${p.number}</span>
                                    <span class="text-xs px-2 py-1 bg-gray-200 rounded">${typeLabel}</span>
                                    ${isPrimary ? '<span class="text-xs px-2 py-1 bg-green-500 text-white rounded">Principal</span>' : ''}
                                </div>
                                <a href="https://wa.me/${p.number.replace(/[^0-9]/g, '')}" 
                                   target="_blank" 
                                   class="text-green-600 hover:text-green-800">
                                    <i class="fab fa-whatsapp text-lg"></i>
                                </a>
                            </div>
                        `;
                    }).join('')}
                </div>
                ${phoneSummary.mobile > 0 || phoneSummary.direct > 0 ? `
                    <div class="mt-2 text-xs text-gray-600">
                        ‚úÖ ${phoneSummary.mobile > 0 ? `${phoneSummary.mobile} celular${phoneSummary.mobile > 1 ? 'es' : ''}` : ''}
                        ${phoneSummary.mobile > 0 && phoneSummary.direct > 0 ? ' ‚Ä¢ ' : ''}
                        ${phoneSummary.direct > 0 ? `${phoneSummary.direct} direto${phoneSummary.direct > 1 ? 's' : ''}` : ''}
                    </div>
                ` : ''}
            </div>
        `;
    } else if (phone) {
        // Fallback para formato antiguo con un solo tel√©fono
        phonesHtml = `
            <p class="text-sm font-bold text-green-700">
                <i class="fas fa-phone mr-2"></i>${phone}
                <a href="https://wa.me/${phone.replace(/[^0-9]/g, '')}" 
                   target="_blank" 
                   class="ml-2 text-green-600 hover:text-green-800">
                    <i class="fab fa-whatsapp"></i>
                </a>
            </p>
        `;
    } else {
        phonesHtml = '<p class="text-sm text-red-600"><i class="fas fa-times mr-2"></i>Telefone n√£o encontrado</p>';
    }
    
    // Procesar todos los emails si vienen m√∫ltiples
    const allEmails = contact.all_emails || [];
    let emailsHtml = '';
    
    if (allEmails && allEmails.length > 0) {
        emailsHtml = `
            <div class="space-y-1">
                ${allEmails.map((e, idx) => `
                    <p class="text-sm ${idx === 0 ? 'font-semibold' : ''}">
                        <i class="fas fa-envelope mr-2"></i>${e.email || e}
                        ${idx === 0 ? ' <span class="text-xs text-gray-500">(Principal)</span>' : ''}
                    </p>
                `).join('')}
            </div>
        `;
    } else if (email !== 'N√£o dispon√≠vel') {
        emailsHtml = `<p class="text-sm"><i class="fas fa-envelope mr-2"></i>${email}</p>`;
    } else {
        emailsHtml = `<p class="text-sm text-gray-500"><i class="fas fa-envelope mr-2"></i>Email n√£o dispon√≠vel</p>`;
    }
    
    resultDiv.innerHTML = `
        <div class="mt-4 space-y-4">
            <!-- Contact Info -->
            <div class="bg-green-50 p-4 rounded-lg">
                <h5 class="font-bold mb-2">üìû Informa√ß√µes de Contato</h5>
                <div class="space-y-2">
                    ${emailsHtml}
                    ${phonesHtml}
                    ${contact.linkedin_url ? 
                        `<p class="text-sm"><i class="fab fa-linkedin mr-2"></i><a href="${contact.linkedin_url}" target="_blank" class="text-blue-600 hover:underline">Ver perfil LinkedIn</a></p>` : 
                        ''
                    }
                </div>
            </div>
            
            <!-- Company Context (NEW) -->
            ${analysis.company_context ? `
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h5 class="font-bold mb-2">üè¢ Contexto da Empresa</h5>
                    <p class="text-sm text-gray-700">${analysis.company_context}</p>
                </div>
            ` : ''}
            
            <!-- Key Talking Points (NEW) -->
            ${analysis.key_talking_points && analysis.key_talking_points.length > 0 ? `
                <div class="bg-yellow-50 p-4 rounded-lg">
                    <h5 class="font-bold mb-2">üí° Pontos-Chave para Abordagem</h5>
                    <ul class="space-y-1">
                        ${analysis.key_talking_points.map(point => 
                            `<li class="text-sm flex items-start">
                                <span class="text-yellow-600 mr-2">‚ñ∏</span>
                                <span>${point}</span>
                            </li>`
                        ).join('')}
                    </ul>
                </div>
            ` : ''}
            
            <!-- PPVVC Analysis -->
            <div class="bg-white border-2 border-indigo-200 rounded-lg p-4">
                <div class="flex justify-between items-center mb-3">
                    <h5 class="font-bold">An√°lise PPVVC</h5>
                    <span class="px-3 py-1 bg-${priorityColor}-500 text-white rounded-full font-bold">
                        ${priority} - ${score}/10
                    </span>
                </div>
                
                <div class="grid grid-cols-3 gap-2 mb-3">
                    ${Object.entries(analysis.scores || {}).map(([key, value]) => `
                        <div class="text-center p-2 bg-gray-50 rounded">
                            <div class="text-xs font-semibold text-gray-600">${key.toUpperCase()}</div>
                            <div class="text-xl font-bold ${value >= 7 ? 'text-green-600' : value >= 5 ? 'text-yellow-600' : 'text-red-600'}">
                                ${value}/10
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="bg-gray-50 p-3 rounded text-sm">
                    <p class="font-semibold mb-1">Justificativa:</p>
                    <p class="text-gray-700">${analysis.justification || 'N/A'}</p>
                </div>
                
                <!-- Recommended Case Study (NEW) -->
                ${analysis.recommended_case_study ? `
                    <div class="bg-green-50 p-3 rounded mt-3">
                        <p class="font-semibold text-green-900 mb-1">
                            <i class="fas fa-briefcase mr-2"></i>Case Recomendado:
                        </p>
                        <p class="text-green-800 text-sm">${analysis.recommended_case_study}</p>
                    </div>
                ` : ''}
                
                <!-- Discovery Questions (NEW) -->
                ${analysis.discovery_questions && analysis.discovery_questions.length > 0 ? `
                    <div class="bg-purple-50 p-3 rounded mt-3">
                        <p class="font-semibold text-purple-900 mb-2">
                            <i class="fas fa-question-circle mr-2"></i>Perguntas de Descoberta:
                        </p>
                        <ol class="list-decimal list-inside space-y-1">
                            ${analysis.discovery_questions.map(q => 
                                `<li class="text-sm text-purple-800">${q}</li>`
                            ).join('')}
                        </ol>
                    </div>
                ` : ''}
                
                <!-- Approach -->
                <div class="bg-indigo-50 p-3 rounded mt-3">
                    <p class="font-semibold text-indigo-900 mb-1">
                        <i class="fas fa-bullseye mr-2"></i>Abordagem Recomendada:
                    </p>
                    <p class="text-indigo-800">${analysis.approach || 'N/A'}</p>
                </div>
                
                <!-- Objection Handling -->
                ${analysis.objection_handling ? `
                    <div class="bg-red-50 p-3 rounded mt-3">
                        <p class="font-semibold text-red-900 mb-1">
                            <i class="fas fa-shield-alt mr-2"></i>Obje√ß√£o Prov√°vel:
                        </p>
                        <p class="text-red-800 text-sm">${analysis.objection_handling}</p>
                    </div>
                ` : ''}
                
                ${analysis.estimated_boxes_day ? `
                    <div class="text-center mt-3 pt-3 border-t">
                        <span class="text-sm text-gray-600">Volume Estimado:</span>
                        <span class="text-lg font-bold text-indigo-600 ml-2">${analysis.estimated_boxes_day} caixas/dia</span>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}
    
// Initialize
document.addEventListener('DOMContentLoaded', () => {
    updateStepIndicator(1);
    
    // Enter key en b√∫squeda por nombre
    document.getElementById('companyNameInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchByCompanyName();
        }
    });
});
</script>

</body>
</html>
