<!DOCTYPE html>se
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ventapel Prospector - Sistema Inteligente PPVVC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-lg border-b-4 border-blue-600">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div>
                    <h1 class="text-2xl font-bold">Ventapel Prospector Brasil</h1>
                    <p class="text-xs text-gray-600">Sistema de Qualifica√ß√£o PPVVC - Mercado Brasileiro</p>
                </div>
                <div class="text-sm text-gray-600">
                    <span class="bg-green-100 px-2 py-1 rounded">Apollo</span>
                    <span class="bg-purple-100 px-2 py-1 rounded">Claude AI</span>
                    <span class="bg-blue-100 px-2 py-1 rounded">Supabase</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- Filtros de Score Autom√°tico -->
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
            <div class="flex items-center">
                <i class="fas fa-info-circle text-yellow-600 mr-2"></i>
                <div>
                    <p class="text-sm font-semibold">Sistema de Scoring Autom√°tico Ativo</p>
                    <p class="text-xs text-gray-600">
                        Volume m√≠nimo: 10.000 envios/m√™s | Faturamento: >R$ 50M | 
                        Foco: E-commerce, 3PL, Alimentos, Farmac√™utica, Cosm√©tica, Automotiva
                    </p>
                </div>
            </div>
        </div>

        <!-- Painel de Busca Inteligente -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">
                <i class="fas fa-search mr-2"></i>Busca Inteligente de Prospectos B2B
            </h2>
            
            <!-- Filtros Principais -->
            <div class="grid grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Ind√∫stria Priorit√°ria</label>
                    <select id="industryFilter" class="w-full p-2 border rounded">
                        <option value="">Todas as Ind√∫strias</option>
                        <option value="e-commerce">E-commerce/Marketplace (Alta Prioridade)</option>
                        <option value="logistics">3PL/Log√≠stica/Fulfillment (Alta)</option>
                        <option value="food">Alimentos e Bebidas (Alta)</option>
                        <option value="pharma">Farmac√™utica/Hospitalar (Alta)</option>
                        <option value="cosmetics">Cosm√©tica/Beleza (Alta)</option>
                        <option value="automotive">Automotiva/Autope√ßas (M√©dia)</option>
                        <option value="retail">Varejo/T√™xtil (M√©dia)</option>
                        <option value="manufacturing">Ind√∫stria Geral (Baixa)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Cargo Estrat√©gico (Decisor)</label>
                    <select id="titleFilter" class="w-full p-2 border rounded">
                        <option value="quality">Gerente de Qualidade (Score +15)</option>
                        <option value="operations">Gerente de Opera√ß√µes (Score +15)</option>
                        <option value="logistics">Gerente de Log√≠stica (Score +15)</option>
                        <option value="production">Gerente de Produ√ß√£o (Score +15)</option>
                        <option value="supply">Gerente Supply Chain (Score +15)</option>
                        <option value="director">Diretor Opera√ß√µes/Industrial (Score +20)</option>
                        <option value="vp">VP/Head de Opera√ß√µes (Score +20)</option>
                        <option value="ceo">CEO/Presidente (Score +25)</option>
                        <option value="compras">Compras/Procurement (Score +5)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Regi√£o Brasil (Foco)</label>
                    <select id="locationFilter" class="w-full p-2 border rounded">
                        <option value="S√£o Paulo, Brazil">S√£o Paulo - SP (Prioridade)</option>
                        <option value="Rio de Janeiro, Brazil">Rio de Janeiro - RJ</option>
                        <option value="Minas Gerais, Brazil">Minas Gerais - MG</option>
                        <option value="Santa Catarina, Brazil">Santa Catarina - SC</option>
                        <option value="Paran√°, Brazil">Paran√° - PR</option>
                        <option value="Rio Grande do Sul, Brazil">Rio Grande do Sul - RS</option>
                        <option value="Brazil">Brasil (Todos Estados)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Porte da Empresa</label>
                    <select id="sizeFilter" class="w-full p-2 border rounded">
                        <option value="5001,10000">5001+ funcion√°rios (Enterprise)</option>
                        <option value="1001,5000">1001-5000 (Grande Porte)</option>
                        <option value="501,1000">501-1000 (M√©dio-Grande)</option>
                        <option value="201,500">201-500 (M√©dio)</option>
                        <option value="51,200">51-200 (Pequeno-M√©dio)</option>
                    </select>
                </div>
            </div>

            <!-- Filtros Avan√ßados de Qualifica√ß√£o -->
            <div class="border-t pt-4 mb-4">
                <button onclick="toggleAdvanced()" class="text-sm text-blue-600 hover:text-blue-800">
                    <i class="fas fa-cog mr-1"></i>Filtros Avan√ßados de Qualifica√ß√£o
                </button>
                <div id="advancedFilters" class="hidden mt-4 space-y-3">
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Palavras-chave de Dor</label>
                            <input type="text" id="painKeywords" 
                                   placeholder="devolu√ß√£o, avaria, viola√ß√£o, roubo" 
                                   class="w-full p-2 border rounded text-sm">
                            <p class="text-xs text-gray-500 mt-1">+10 pontos se encontrado</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Sinais de Compra</label>
                            <input type="text" id="buySignals" 
                                   placeholder="expans√£o, nova f√°brica, IPO" 
                                   class="w-full p-2 border rounded text-sm">
                            <p class="text-xs text-gray-500 mt-1">+15 pontos se encontrado</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Tecnologias Atuais</label>
                            <input type="text" id="techKeywords" 
                                   placeholder="SAP, WMS, Totvs" 
                                   class="w-full p-2 border rounded text-sm">
                            <p class="text-xs text-gray-500 mt-1">Indica maturidade digital</p>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-3 rounded">
                        <p class="text-xs font-semibold mb-2">Descalificadores Autom√°ticos:</p>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <label class="flex items-center">
                                <input type="checkbox" id="excludeSmall" checked class="mr-2">
                                Excluir <1000 envios/m√™s
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="excludeRetail" checked class="mr-2">
                                Excluir varejo f√≠sico sem e-commerce
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="excludeRJ" checked class="mr-2">
                                Excluir empresas em RJ
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="excludeClients" checked class="mr-2">
                                Excluir clientes atuais
                            </label>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Score M√≠nimo (0-100)</label>
                            <select id="minScore" class="w-full p-2 border rounded">
                                <option value="0">Sem m√≠nimo</option>
                                <option value="50">‚â•50 (Tier C - Nutrir)</option>
                                <option value="60">‚â•60 (Tier B - 72h)</option>
                                <option value="70">‚â•70 (Tier A - 24h)</option>
                                <option value="80">‚â•80 (Hot Lead)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Faturamento Anual Estimado</label>
                            <select id="revenueFilter" class="w-full p-2 border rounded">
                                <option value="">Todos</option>
                                <option value="50">‚â•R$ 50M</option>
                                <option value="200">‚â•R$ 200M (Ideal)</option>
                                <option value="500">‚â•R$ 500M (Estrat√©gico)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-between items-center">
                <button onclick="searchProspects()" 
                        class="px-6 py-3 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                    <i class="fas fa-search mr-2"></i>Buscar Prospectos Qualificados
                </button>
                
                <div class="flex gap-2">
                    <button onclick="searchByCompanyName()" 
                            class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm">
                        <i class="fas fa-building mr-2"></i>Buscar Empresa Espec√≠fica
                    </button>
                    <button onclick="exportResults('csv')" 
                            class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
                        <i class="fas fa-download mr-2"></i>Exportar CSV
                    </button>
                </div>
            </div>
        </div>

        <!-- Painel de M√©tricas e KPIs -->
        <div class="grid grid-cols-5 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-2xl font-bold text-blue-600" id="totalFound">0</div>
                <div class="text-xs text-gray-600">Prospectos Encontrados</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-2xl font-bold text-green-600" id="avgScore">0</div>
                <div class="text-xs text-gray-600">Score M√©dio (0-100)</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-2xl font-bold text-purple-600" id="withContact">0</div>
                <div class="text-xs text-gray-600">Com Contato</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-2xl font-bold text-orange-600" id="tierA">0</div>
                <div class="text-xs text-gray-600">Tier A (24h)</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-2xl font-bold text-yellow-600" id="tierB">0</div>
                <div class="text-xs text-gray-600">Tier B (72h)</div>
            </div>
        </div>

        <!-- Resultados com Scoring -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold">Resultados com An√°lise PPVVC</h3>
                <div class="flex gap-2">
                    <button onclick="sortResults('score')" class="text-sm px-3 py-1 border rounded hover:bg-gray-50">
                        <i class="fas fa-sort-amount-down"></i> Por Score
                    </button>
                    <button onclick="sortResults('company')" class="text-sm px-3 py-1 border rounded hover:bg-gray-50">
                        <i class="fas fa-sort-alpha-down"></i> Por Empresa
                    </button>
                    <button onclick="filterTier('A')" class="text-sm px-3 py-1 border rounded hover:bg-orange-50 text-orange-600">
                        <i class="fas fa-fire"></i> S√≥ Tier A
                    </button>
                </div>
            </div>
            <div id="results">
                <p class="text-gray-500">Nenhuma busca realizada</p>
            </div>
        </div>
    </div>

    <!-- Modal de An√°lise PPVVC Detalhada -->
    <div id="analysisModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-[700px] shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">An√°lise Detalhada PPVVC + Scoring</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="analysisContent"></div>
            </div>
        </div>
    </div>

    <script>
    // CONFIGURA√á√ÉO BASEADA NOS DOCUMENTOS VENTAPEL
    const INDUSTRY_MAPPING = {
        'e-commerce': {
            keywords: ['e-commerce', 'marketplace', 'com√©rcio eletr√¥nico', 'loja virtual', 'online'],
            score: 10,
            priority: 'alta'
        },
        'logistics': {
            keywords: ['log√≠stica', '3PL', 'fulfillment', 'armaz√©m', 'distribui√ß√£o', 'supply chain'],
            score: 10,
            priority: 'alta'
        },
        'food': {
            keywords: ['alimentos', 'bebidas', 'food', 'aliment√≠cio', 'FMCG'],
            score: 10,
            priority: 'alta'
        },
        'pharma': {
            keywords: ['farmac√™utica', 'pharmaceutical', 'medicamentos', 'hospitalar', 'sa√∫de'],
            score: 10,
            priority: 'alta'
        },
        'cosmetics': {
            keywords: ['cosm√©tica', 'beleza', 'beauty', 'personal care', 'higiene'],
            score: 10,
            priority: 'alta'
        },
        'automotive': {
            keywords: ['automotiva', 'automotive', 'autope√ßas', 've√≠culos', 'montadora'],
            score: 5,
            priority: 'm√©dia'
        },
        'retail': {
            keywords: ['varejo', 'retail', 'loja', 'moda', 't√™xtil', 'fashion'],
            score: 3,
            priority: 'm√©dia'
        },
        'manufacturing': {
            keywords: ['ind√∫stria', 'manufatura', 'f√°brica', 'industrial', 'produ√ß√£o'],
            score: 2,
            priority: 'baixa'
        }
    };

    const TITLE_MAPPING = {
        'quality': {
            titles: ['Gerente de Qualidade', 'Gerente da Qualidade', 'Quality Manager', 'Coordenador de Qualidade'],
            score: 15
        },
        'operations': {
            titles: ['Gerente de Opera√ß√µes', 'Operations Manager', 'Gerente Operacional', 'COO'],
            score: 15
        },
        'logistics': {
            titles: ['Gerente de Log√≠stica', 'Logistics Manager', 'Gerente Log√≠stico', 'Supply Chain Manager'],
            score: 15
        },
        'production': {
            titles: ['Gerente de Produ√ß√£o', 'Production Manager', 'Gerente Industrial', 'Plant Manager'],
            score: 15
        },
        'supply': {
            titles: ['Supply Chain Manager', 'Gerente de Supply Chain', 'Head of Supply Chain'],
            score: 15
        },
        'director': {
            titles: ['Diretor de Opera√ß√µes', 'Diretor Industrial', 'Operations Director', 'VP Operations'],
            score: 20
        },
        'vp': {
            titles: ['VP', 'Vice President', 'Vice-Presidente', 'Head of Operations'],
            score: 20
        },
        'ceo': {
            titles: ['CEO', 'President', 'Presidente', 'Chief Executive', 'S√≥cio Diretor'],
            score: 25
        },
        'compras': {
            titles: ['Compras', 'Procurement', 'Suprimentos', 'Buyer', 'Comprador'],
            score: 5
        }
    };

    // Clientes atuais para excluir
    const CURRENT_CLIENTS = [
        'Mercado Livre', 'Amazon', 'Honda', 'Toyota', 'L\'Or√©al', 
        'Nike', 'Puma', 'Nestl√©', 'Bayer', 'McCain'
    ];

    let currentResults = [];
    let analyzedResults = [];

    async function searchProspects() {
    const industry = document.getElementById('industryFilter').value;
    const titleType = document.getElementById('titleFilter').value;
    const location = document.getElementById('locationFilter').value;
    const size = document.getElementById('sizeFilter').value;
    
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = '<p class="text-blue-600"><i class="fas fa-spinner fa-spin mr-2"></i>Buscando prospectos qualificados...</p>';
    
    try {
        // 1. Buscar en Apollo
        const response = await fetch('/api/apollo-search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                query: '',
                filters: {
                    titles: ['Gerente de Opera√ß√µes', 'Operations Manager', 'Gerente'],
                    location: location || 'Brazil',
                    size: size
                }
            })
        });
        
        if (!response.ok) throw new Error(`Error ${response.status}`);
        
        const data = await response.json();
        let prospects = data.people || [];
        
        // 2. ENRIQUECER CON SERPER (NUEVO)
        resultsDiv.innerHTML = '<p class="text-purple-600"><i class="fas fa-spinner fa-spin mr-2"></i>Enriqueciendo con inteligencia de mercado...</p>';
        
        const enrichedProspects = [];
        for (const prospect of prospects.slice(0, 5)) { // Solo los primeros 5 para no gastar cr√©ditos
            if (prospect.organization?.name) {
                try {
                    const enrichResponse = await fetch('/api/enrich-prospect', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            company: prospect.organization,
                            contact: prospect
                        })
                    });
                    
                    const enrichData = await enrichResponse.json();
                    
                    enrichedProspects.push({
                        ...prospect,
                        enrichment: enrichData.enriched ? enrichData.enrichmentData : null,
                        enrichmentScore: enrichData.additionalScore || 0,
                        enrichmentSummary: enrichData.summary || ''
                    });
                } catch (error) {
                    console.error('Error enriching:', error);
                    enrichedProspects.push(prospect);
                }
            } else {
                enrichedProspects.push(prospect);
            }
        }
        
        // Agregar los no enriquecidos
        enrichedProspects.push(...prospects.slice(5));
        
        // 3. Mostrar resultados enriquecidos
        displayEnrichedResults(enrichedProspects);
        
    } catch (error) {
        console.error('Error:', error);
        resultsDiv.innerHTML = `
            <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
                <p class="font-bold">Erro ao buscar prospectos</p>
                <p class="text-sm">${error.message}</p>
            </div>
        `;
    }
}

function displayEnrichedResults(prospects) {
    const resultsDiv = document.getElementById('results');
    
    if (prospects.length === 0) {
        resultsDiv.innerHTML = '<p class="text-gray-500">Nenhum prospecto encontrado</p>';
        return;
    }
    
    let html = '<div class="space-y-4">';
    
    prospects.forEach(person => {
        const hasEnrichment = person.enrichment && person.enrichmentScore > 0;
        const borderColor = hasEnrichment && person.enrichmentScore > 20 ? 'border-orange-400' : 'border-gray-200';
        
        html += `
            <div class="border ${borderColor} rounded-lg p-4 hover:shadow-md transition-shadow ${hasEnrichment ? 'bg-orange-50' : ''}">
                <div class="flex justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <h4 class="font-semibold text-lg">${person.name || 'Nome n√£o dispon√≠vel'}</h4>
                            ${hasEnrichment && person.enrichmentScore > 20 ? 
                                '<span class="px-2 py-1 bg-orange-500 text-white text-xs rounded">üî• HOT LEAD</span>' : ''}
                        </div>
                        
                        <p class="text-gray-600">${person.title || 'Cargo n√£o especificado'}</p>
                        <p class="text-blue-600 font-medium">${person.organization?.name || 'Empresa n√£o especificada'}</p>
                        
                        <!-- Dados de contato -->
                        <div class="mt-2 text-sm space-y-1">
                            ${person.email ? `
                                <div>
                                    <i class="fas fa-envelope mr-1 text-gray-400"></i>
                                    <a href="mailto:${person.email}" class="text-blue-500">${person.email}</a>
                                </div>
                            ` : '<div class="text-gray-400"><i class="fas fa-envelope mr-1"></i>Email n√£o dispon√≠vel</div>'}
                            
                            ${person.phone_numbers?.[0] ? `
                                <div>
                                    <i class="fas fa-phone mr-1 text-gray-400"></i>
                                    ${person.phone_numbers[0].sanitized_number || person.phone_numbers[0].number}
                                </div>
                            ` : ''}
                            
                            ${person.linkedin_url ? `
                                <div>
                                    <i class="fab fa-linkedin mr-1 text-gray-400"></i>
                                    <a href="${person.linkedin_url}" target="_blank" class="text-blue-500">Ver LinkedIn</a>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- ENRIQUECIMENTO SERPER (NOVO) -->
                        ${hasEnrichment ? `
                            <div class="mt-3 p-3 bg-white rounded border border-yellow-400">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-sm font-semibold">üîç Intelig√™ncia de Mercado</span>
                                    <span class="text-xs bg-yellow-100 px-2 py-1 rounded">+${person.enrichmentScore} pontos</span>
                                </div>
                                
                                ${person.enrichment.publicProblems?.length > 0 ? `
                                    <div class="text-sm text-red-600 mb-2">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>
                                        <strong>Problemas detectados:</strong> ${person.enrichment.publicProblems[0].issue}
                                    </div>
                                ` : ''}
                                
                                ${person.enrichment.buyingSignals?.length > 0 ? `
                                    <div class="text-sm text-green-600 mb-2">
                                        <i class="fas fa-shopping-cart mr-1"></i>
                                        <strong>Buscando fornecedores!</strong>
                                    </div>
                                ` : ''}
                                
                                ${person.enrichment.news?.length > 0 ? `
                                    <div class="text-sm text-blue-600 mb-2">
                                        <i class="fas fa-newspaper mr-1"></i>
                                        <strong>Not√≠cia recente:</strong> ${person.enrichment.news[0].title}
                                    </div>
                                ` : ''}
                                
                                ${person.enrichmentSummary ? `
                                    <div class="text-xs text-gray-700 mt-2 pt-2 border-t">
                                        ${person.enrichmentSummary}
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="ml-4 space-y-2">
                        ${hasEnrichment && person.enrichmentScore > 20 ? `
                            <button onclick="alert('Contato priorit√°rio - implementar a√ß√£o r√°pida')" 
                                    class="px-4 py-2 bg-orange-600 text-white rounded text-sm hover:bg-orange-700 w-full">
                                <i class="fas fa-bolt mr-1"></i>A√ß√£o Imediata
                            </button>
                        ` : ''}
                        
                        <button onclick="saveProspect(${JSON.stringify(person).replace(/'/g, '&apos;').replace(/"/g, '&quot;')})" 
                                class="px-4 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700 w-full">
                            <i class="fas fa-save mr-1"></i>Salvar
                        </button>
                        
                        ${person.linkedin_url ? `
                            <button onclick="window.open('${person.linkedin_url}', '_blank')" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 w-full">
                                <i class="fab fa-linkedin mr-1"></i>LinkedIn
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    resultsDiv.innerHTML = html;
    
    // Actualizar estad√≠sticas
    updateEnrichedStats(prospects);
}

function updateEnrichedStats(prospects) {
    document.getElementById('totalFound').textContent = prospects.length;
    
    const withContact = prospects.filter(p => p.email || p.phone_numbers?.length > 0).length;
    document.getElementById('withContact').textContent = withContact;
    
    const hotLeads = prospects.filter(p => p.enrichmentScore > 20).length;
    document.getElementById('tierA').textContent = hotLeads;
    
    const avgScore = prospects.reduce((sum, p) => sum + (p.enrichmentScore || 0), 0) / prospects.length;
    document.getElementById('avgScore').textContent = Math.round(avgScore);
}

function saveProspect(person) {
    // Implementar guardado
    console.log('Salvando:', person);
    alert('Prospecto salvo!');
}

    async function analyzeAndScoreProspects(prospects) {
        analyzedResults = [];
        
        for (const prospect of prospects) {
            // Calcular score baseado nos crit√©rios
            let score = 0;
            let scoreDetails = {
                dolor: 0,
                poder: 0,
                sinais: 0,
                bonus: 0
            };
            
            // DOLOR POTENCIAL (40 pontos max)
            const industry = document.getElementById('industryFilter').value;
            if (industry && INDUSTRY_MAPPING[industry]) {
                scoreDetails.dolor += INDUSTRY_MAPPING[industry].score;
            }
            
            // Verificar palavras-chave de dor
            const painKeywords = document.getElementById('painKeywords')?.value;
            if (painKeywords && prospect.organization?.description) {
                const keywords = painKeywords.split(',').map(k => k.trim());
                if (keywords.some(k => prospect.organization.description.toLowerCase().includes(k.toLowerCase()))) {
                    scoreDetails.dolor += 10;
                }
            }
            
            // Opera√ß√£o 24/7 ou multi-turno (inferido pelo tamanho)
            if (prospect.organization?.estimated_num_employees > 1000) {
                scoreDetails.dolor += 10;
            }
            
            // PODER DE DECIS√ÉO (30 pontos max)
            const titleType = document.getElementById('titleFilter').value;
            if (titleType && TITLE_MAPPING[titleType]) {
                scoreDetails.poder = TITLE_MAPPING[titleType].score;
            }
            
            // Empresa matriz estrangeira (bonus)
            if (prospect.organization?.headquarters_location && 
                !prospect.organization.headquarters_location.includes('Brazil')) {
                scoreDetails.poder += 5;
            }
            
            // SINAIS DE COMPRA (30 pontos max)
            const buySignals = document.getElementById('buySignals')?.value;
            if (buySignals && prospect.organization?.description) {
                const signals = buySignals.split(',').map(s => s.trim());
                if (signals.some(s => prospect.organization.description.toLowerCase().includes(s.toLowerCase()))) {
                    scoreDetails.sinais += 15;
                }
            }
            
            // Score total
            score = scoreDetails.dolor + scoreDetails.poder + scoreDetails.sinais + scoreDetails.bonus;
            
            // Determinar Tier
            let tier = 'C';
            let priority = 'baixa';
            if (score >= 70) {
                tier = 'A';
                priority = 'alta';
            } else if (score >= 50) {
                tier = 'B';
                priority = 'm√©dia';
            }
            
            // An√°lise PPVVC via Claude
            let ppvvcAnalysis = null;
            try {
                ppvvcAnalysis = await analyzeWithClaude(prospect);
            } catch (error) {
                console.error('Erro na an√°lise PPVVC:', error);
            }
            
            analyzedResults.push({
                ...prospect,
                ventapelScore: score,
                scoreDetails: scoreDetails,
                tier: tier,
                priority: priority,
                ppvvc: ppvvcAnalysis
            });
        }
        
        // Ordenar por score
        analyzedResults.sort((a, b) => b.ventapelScore - a.ventapelScore);
        
        // Atualizar estat√≠sticas
        updateStats(analyzedResults);
        
        // Exibir resultados
        displayResults(analyzedResults);
    }

    async function analyzeWithClaude(person) {
        try {
            const response = await fetch('/api/claude-analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    company: person.organization || {},
                    contact: {
                        name: person.name,
                        title: person.title,
                        email: person.email
                    },
                    context: 'ventapel_brasil_b2b'
                })
            });
            
            if (!response.ok) throw new Error('Erro na an√°lise');
            
            return await response.json();
            
        } catch (error) {
            console.error('Erro:', error);
            return null;
        }
    }

    function displayResults(results) {
        const resultsDiv = document.getElementById('results');
        
        if (results.length === 0) {
            resultsDiv.innerHTML = '<p class="text-gray-500">Nenhum prospecto encontrado com os filtros aplicados</p>';
            return;
        }
        
        const html = results.map((person, index) => {
            const score = person.ventapelScore;
            const tier = person.tier;
            const tierColor = tier === 'A' ? 'orange' : tier === 'B' ? 'yellow' : 'gray';
            const tierText = tier === 'A' ? 'üî• TIER A - Contatar em 24h' : 
                            tier === 'B' ? '‚ö° TIER B - Contatar em 72h' : 
                            'üìß TIER C - Nutrir com conte√∫do';
            
            return `
                <div class="border rounded-lg p-4 mb-4 hover:shadow-md transition-shadow ${tier === 'A' ? 'border-orange-400 bg-orange-50' : ''}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h4 class="font-semibold text-lg">${person.name || 'Nome n√£o dispon√≠vel'}</h4>
                                <span class="px-2 py-1 bg-${tierColor}-100 text-${tierColor}-800 text-xs rounded font-semibold">
                                    ${tierText}
                                </span>
                            </div>
                            
                            <p class="text-gray-600">${person.title || 'Cargo n√£o especificado'}</p>
                            <p class="text-blue-600 font-medium text-lg">${person.organization?.name || 'Empresa n√£o especificada'}</p>
                            
                            <!-- Informa√ß√µes da Empresa -->
                            ${person.organization ? `
                                <div class="mt-2 p-2 bg-gray-50 rounded text-sm">
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <span class="text-gray-500">Ind√∫stria:</span>
                                            <span class="ml-1">${person.organization.industry || 'N√£o especificada'}</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">Funcion√°rios:</span>
                                            <span class="ml-1">${person.organization.estimated_num_employees || 'N√£o informado'}</span>
                                        </div>
                                        ${person.organization.city ? `
                                            <div>
                                                <span class="text-gray-500">Cidade:</span>
                                                <span class="ml-1">${person.organization.city}, ${person.organization.state || ''}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <!-- Contatos -->
                            <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
                                ${person.email ? `
                                    <div>
                                        <i class="fas fa-envelope mr-1 text-gray-400"></i>
                                        <a href="mailto:${person.email}" class="text-blue-500 hover:underline">${person.email}</a>
                                    </div>
                                ` : '<div class="text-red-400"><i class="fas fa-envelope mr-1"></i>Email n√£o dispon√≠vel ‚ö†Ô∏è</div>'}
                                
                                ${person.phone_numbers?.[0]?.sanitized_number ? `
                                    <div>
                                        <i class="fas fa-phone mr-1 text-gray-400"></i>
                                        <a href="tel:${person.phone_numbers[0].sanitized_number}" class="text-blue-500">
                                            ${person.phone_numbers[0].sanitized_number}
                                        </a>
                                    </div>
                                ` : '<div class="text-red-400"><i class="fas fa-phone mr-1"></i>Telefone n√£o dispon√≠vel ‚ö†Ô∏è</div>'}
                                
                                ${person.linkedin_url ? `
                                    <div>
                                        <i class="fab fa-linkedin mr-1 text-gray-400"></i>
                                        <a href="${person.linkedin_url}" target="_blank" class="text-blue-500 hover:underline">
                                            Perfil LinkedIn
                                        </a>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- Scoring Detalhado -->
                            <div class="mt-3 p-3 bg-white rounded border">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-sm font-semibold">Score de Qualifica√ß√£o Ventapel</span>
                                    <span class="text-2xl font-bold text-${score >= 70 ? 'green' : score >= 50 ? 'yellow' : 'red'}-600">
                                        ${score}/100
                                    </span>
                                </div>
                                <div class="grid grid-cols-3 gap-2 text-xs">
                                    <div>
                                        <span class="text-gray-500">Dor Potencial:</span>
                                        <span class="ml-1 font-semibold">${person.scoreDetails.dolor}/40</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-500">Poder Decis√£o:</span>
                                        <span class="ml-1 font-semibold">${person.scoreDetails.poder}/30</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-500">Sinais Compra:</span>
                                        <span class="ml-1 font-semibold">${person.scoreDetails.sinais}/30</span>
                                    </div>
                                </div>
                                
                                ${person.ppvvc ? `
                                    <div class="mt-2 pt-2 border-t">
                                        <div class="text-xs font-semibold mb-1">An√°lise PPVVC (IA):</div>
                                        <div class="grid grid-cols-6 gap-1 text-xs">
                                            <div class="text-center">
                                                <div class="text-gray-500">Pain</div>
                                                <div class="font-bold">${person.ppvvc.scores?.pain || 0}</div>
                                            </div>
                                            <div class="text-center">
                                                <div class="text-gray-500">Power</div>
                                                <div class="font-bold">${person.ppvvc.scores?.power || 0}</div>
                                            </div>
                                            <div class="text-center">
                                                <div class="text-gray-500">Vision</div>
                                                <div class="font-bold">${person.ppvvc.scores?.vision || 0}</div>
                                            </div>
                                            <div class="text-center">
                                                <div class="text-gray-500">Value</div>
                                                <div class="font-bold">${person.ppvvc.scores?.value || 0}</div>
                                            </div>
                                            <div class="text-center">
                                                <div class="text-gray-500">Control</div>
                                                <div class="font-bold">${person.ppvvc.scores?.control || 0}</div>
                                            </div>
                                            <div class="text-center">
                                                <div class="text-gray-500">Compras</div>
                                                <div class="font-bold">${person.ppvvc.scores?.compras || 0}</div>
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- A√ß√µes -->
                        <div class="ml-4 space-y-2">
                            <button 
                                onclick='showDetailedAnalysis(${JSON.stringify(person).replace(/'/g, "&apos;")})'
                                class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm w-full"
                            >
                                <i class="fas fa-chart-line mr-1"></i>An√°lise Completa
                            </button>
                            
                            ${person.tier === 'A' ? `
                                <button 
                                    onclick='createFollowUpPlan(${JSON.stringify(person).replace(/'/g, "&apos;")})'
                                    class="px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700 text-sm w-full"
                                >
                                    <i class="fas fa-calendar-check mr-1"></i>Criar Follow-up
                                </button>
                            ` : ''}
                            
                            <button 
                                onclick='saveToSuCRM(${JSON.stringify(person).replace(/'/g, "&apos;")})'
                                class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm w-full"
                            >
                                <i class="fas fa-save mr-1"></i>Salvar no CRM
                            </button>
                            
                            ${person.linkedin_url ? `
                                <button 
                                    onclick='generateLinkedInMessage(${JSON.stringify(person).replace(/'/g, "&apos;")})'
                                    class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm w-full"
                                >
                                    <i class="fab fa-linkedin mr-1"></i>Msg LinkedIn
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        resultsDiv.innerHTML = html;
    }

    function updateStats(results) {
        document.getElementById('totalFound').textContent = results.length;
        
        const withContact = results.filter(p => p.email || p.phone_numbers?.length > 0).length;
        document.getElementById('withContact').textContent = withContact;
        
        const avgScore = results.length > 0 
            ? Math.round(results.reduce((sum, r) => sum + r.ventapelScore, 0) / results.length)
            : 0;
        document.getElementById('avgScore').textContent = avgScore;
        
        const tierA = results.filter(r => r.tier === 'A').length;
        document.getElementById('tierA').textContent = tierA;
        
        const tierB = results.filter(r => r.tier === 'B').length;
        document.getElementById('tierB').textContent = tierB;
    }

    function showDetailedAnalysis(person) {
        const modal = document.getElementById('analysisModal');
        const content = document.getElementById('analysisContent');
        
        modal.classList.remove('hidden');
        
        // Gerar mensagem personalizada baseada na ind√∫stria
        let industryMessage = '';
        if (person.organization?.industry?.toLowerCase().includes('commerce') || 
            person.organization?.industry?.toLowerCase().includes('marketplace')) {
            industryMessage = `Vi que a ${person.organization.name} est√° no e-commerce. Em opera√ß√µes similares, reduzimos 40% do retrabalho por viola√ß√£o de caixas. Quanto custa hoje cada devolu√ß√£o por produto danificado?`;
        } else if (person.organization?.industry?.toLowerCase().includes('log') || 
                   person.organization?.industry?.toLowerCase().includes('3pl')) {
            industryMessage = `A ${person.organization.name} gerencia m√∫ltiplos clientes com diferentes SLAs. Nossa solu√ß√£o reduziu 95% as penaliza√ß√µes por avaria em tr√¢nsito. Voc√™s t√™m KPIs de integridade de pacotes?`;
        } else if (person.organization?.industry?.toLowerCase().includes('farm') || 
                   person.organization?.industry?.toLowerCase().includes('cosm')) {
            industryMessage = `Rastreabilidade e seguran√ßa s√£o cr√≠ticas na ind√∫stria ${person.organization.industry}. Nosso sistema garante inviolabilidade 100% com evid√™ncia vis√≠vel. Como gerenciam hoje os riscos de adultera√ß√£o?`;
        }
        
        content.innerHTML = `
            <div class="space-y-4">
                <!-- Informa√ß√µes do Prospecto -->
                <div class="bg-gradient-to-r from-blue-50 to-green-50 p-4 rounded">
                    <h4 class="font-bold text-lg">${person.name}</h4>
                    <p class="text-gray-600">${person.title}</p>
                    <p class="text-blue-600 font-semibold">${person.organization?.name || 'Empresa n√£o especificada'}</p>
                    <div class="mt-2 flex gap-4 text-sm">
                        ${person.email ? `<span><i class="fas fa-envelope mr-1"></i>${person.email}</span>` : ''}
                        ${person.phone_numbers?.[0]?.sanitized_number ? `<span><i class="fas fa-phone mr-1"></i>${person.phone_numbers[0].sanitized_number}</span>` : ''}
                    </div>
                </div>
                
                <!-- Score de Qualifica√ß√£o -->
                <div class="bg-white border rounded p-4">
                    <h5 class="font-semibold mb-3">Score de Qualifica√ß√£o Ventapel</h5>
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-3xl font-bold text-${person.ventapelScore >= 70 ? 'green' : person.ventapelScore >= 50 ? 'yellow' : 'red'}-600">
                            ${person.ventapelScore}/100
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-semibold text-${person.tier === 'A' ? 'orange' : person.tier === 'B' ? 'yellow' : 'gray'}-600">
                                TIER ${person.tier}
                            </div>
                            <div class="text-sm text-gray-500">
                                ${person.tier === 'A' ? 'Contatar em 24h' : person.tier === 'B' ? 'Contatar em 72h' : 'Nutrir com conte√∫do'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Dor Potencial (40 max):</span>
                            <span class="font-semibold">${person.scoreDetails.dolor}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Poder de Decis√£o (30 max):</span>
                            <span class="font-semibold">${person.scoreDetails.poder}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Sinais de Compra (30 max):</span>
                            <span class="font-semibold">${person.scoreDetails.sinais}</span>
                        </div>
                    </div>
                </div>
                
                <!-- An√°lise PPVVC -->
                ${person.ppvvc ? `
                    <div class="bg-white border rounded p-4">
                        <h5 class="font-semibold mb-3">An√°lise PPVVC (Metodologia Ventapel)</h5>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="text-center p-2 bg-blue-50 rounded">
                                <div class="text-xs text-gray-600">Pain</div>
                                <div class="text-xl font-bold">${person.ppvvc.scores?.pain || 0}/10</div>
                            </div>
                            <div class="text-center p-2 bg-blue-50 rounded">
                                <div class="text-xs text-gray-600">Power</div>
                                <div class="text-xl font-bold">${person.ppvvc.scores?.power || 0}/10</div>
                            </div>
                            <div class="text-center p-2 bg-blue-50 rounded">
                                <div class="text-xs text-gray-600">Vision</div>
                                <div class="text-xl font-bold">${person.ppvvc.scores?.vision || 0}/10</div>
                            </div>
                            <div class="text-center p-2 bg-green-50 rounded">
                                <div class="text-xs text-gray-600">Value</div>
                                <div class="text-xl font-bold">${person.ppvvc.scores?.value || 0}/10</div>
                            </div>
                            <div class="text-center p-2 bg-green-50 rounded">
                                <div class="text-xs text-gray-600">Control</div>
                                <div class="text-xl font-bold">${person.ppvvc.scores?.control || 0}/10</div>
                            </div>
                            <div class="text-center p-2 bg-green-50 rounded">
                                <div class="text-xs text-gray-600">Compras</div>
                                <div class="text-xl font-bold">${person.ppvvc.scores?.compras || 0}/10</div>
                            </div>
                        </div>
                        
                        ${person.ppvvc.reasoning ? `
                            <div class="mt-3 p-3 bg-gray-50 rounded">
                                <p class="text-sm font-semibold mb-1">An√°lise:</p>
                                <p class="text-sm text-gray-600">${person.ppvvc.reasoning}</p>
                            </div>
                        ` : ''}
                        
                        ${person.ppvvc.recommended_approach ? `
                            <div class="mt-3 p-3 bg-yellow-50 rounded">
                                <p class="text-sm font-semibold mb-1">Abordagem Recomendada:</p>
                                <p class="text-sm text-gray-600">${person.ppvvc.recommended_approach}</p>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
                
                <!-- Mensagem Personalizada -->
                ${industryMessage ? `
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
                        <p class="text-sm font-semibold mb-2">Mensagem Personalizada para ${person.organization?.industry || 'Ind√∫stria'}:</p>
                        <p class="text-sm text-gray-700 italic">"${industryMessage}"</p>
                    </div>
                ` : ''}
                
                <!-- Pr√≥ximos Passos -->
                <div class="bg-gray-50 p-4 rounded">
                    <h5 class="font-semibold mb-2">Pr√≥ximos Passos Recomendados:</h5>
                    <ol class="list-decimal list-inside space-y-1 text-sm">
                        ${person.tier === 'A' ? `
                            <li>Contato via LinkedIn hoje mesmo</li>
                            <li>Mencionar caso de sucesso similar na ind√∫stria</li>
                            <li>Propor reuni√£o de 15 minutos esta semana</li>
                            <li>Preparar demo personalizada com ROI estimado</li>
                        ` : person.tier === 'B' ? `
                            <li>Adicionar no LinkedIn e enviar mensagem em 48h</li>
                            <li>Compartilhar case study relevante</li>
                            <li>Agendar follow-up para pr√≥xima semana</li>
                        ` : `
                            <li>Adicionar √† lista de email marketing</li>
                            <li>Enviar conte√∫do educativo mensal</li>
                            <li>Monitorar sinais de compra</li>
                        `}
                    </ol>
                </div>
                
                <!-- A√ß√µes -->
                <div class="flex gap-2 pt-4 border-t">
                    <button onclick="exportProspect(${JSON.stringify(person).replace(/'/g, "&apos;")})" 
                            class="flex-1 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                        <i class="fas fa-download mr-2"></i>Exportar Dados
                    </button>
                    <button onclick="saveToSuCRM(${JSON.stringify(person).replace(/'/g, "&apos;")})" 
                            class="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        <i class="fas fa-save mr-2"></i>Salvar no CRM
                    </button>
                    <button onclick="closeModal()" 
                            class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                        Fechar
                    </button>
                </div>
            </div>
        `;
    }

    function generateLinkedInMessage(person) {
        let message = '';
        
        if (person.tier === 'A') {
            message = `Ol√° ${person.name.split(' ')[0]},\n\n`;
            message += `Vi que voc√™ √© ${person.title} na ${person.organization?.name}. `;
            
            if (person.organization?.industry?.toLowerCase().includes('commerce')) {
                message += `Em opera√ß√µes de e-commerce similares, conseguimos reduzir 40% do retrabalho por viola√ß√£o de caixas.\n\n`;
                message += `Seria interessante compartilhar como o Mercado Livre e outros grandes players resolveram esse desafio?\n\n`;
            } else {
                message += `Ajudamos empresas como a sua a reduzir at√© 64% dos custos com sistema de fechamento de caixas.\n\n`;
                message += `Teria 15 minutos esta semana para uma conversa r√°pida sobre como eliminar perdas por viola√ß√£o em tr√¢nsito?\n\n`;
            }
            
            message += `Abra√ßos,\n[Seu Nome]\nVentapel Brasil`;
        }
        
        alert('Mensagem LinkedIn copiada:\n\n' + message);
        navigator.clipboard.writeText(message);
    }

    function exportResults(format) {
        if (analyzedResults.length === 0) {
            alert('Nenhum resultado para exportar');
            return;
        }
        
        let csvContent = "Nome,Cargo,Empresa,Email,Telefone,LinkedIn,Score Ventapel,Tier,Dor,Poder,Sinais,PPVVC Total,Ind√∫stria,Funcion√°rios,Cidade\n";
        
        analyzedResults.forEach(person => {
            const row = [
                person.name || '',
                person.title || '',
                person.organization?.name || '',
                person.email || '',
                person.phone_numbers?.[0]?.sanitized_number || '',
                person.linkedin_url || '',
                person.ventapelScore || '0',
                person.tier || '',
                person.scoreDetails?.dolor || '0',
                person.scoreDetails?.poder || '0',
                person.scoreDetails?.sinais || '0',
                person.ppvvc?.total_score || '0',
                person.organization?.industry || '',
                person.organization?.estimated_num_employees || '',
                person.organization?.city || ''
            ].map(field => `"${field}"`).join(',');
            
            csvContent += row + "\n";
        });
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `ventapel_prospectos_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    async function saveToSuCRM(person) {
        try {
            const response = await fetch('/api/save-prospect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    // Dados da empresa
                    company_name: person.organization?.name || 'Sem empresa',
                    company_domain: person.organization?.domain,
                    company_industry: person.organization?.industry,
                    company_size: person.organization?.estimated_num_employees?.toString(),
                    company_location: `${person.organization?.city || ''}, ${person.organization?.state || ''}, Brazil`,
                    
                    // Dados do contato
                    contact_name: person.name,
                    contact_title: person.title,
                    contact_email: person.email,
                    contact_phone: person.phone_numbers?.[0]?.sanitized_number,
                    contact_linkedin: person.linkedin_url,
                    
                    // Scores
                    pain_score: person.ppvvc?.scores?.pain || 0,
                    power_score: person.ppvvc?.scores?.power || 0,
                    vision_score: person.ppvvc?.scores?.vision || 0,
                    value_score: person.ppvvc?.scores?.value || 0,
                    control_score: person.ppvvc?.scores?.control || 0,
                    compras_score: person.ppvvc?.scores?.compras || 0,
                    total_score: person.ppvvc?.total_score || 0,
                    
                    // An√°lise Ventapel
                    ventapel_score: person.ventapelScore,
                    tier: person.tier,
                    priority: person.priority,
                    score_details: JSON.stringify(person.scoreDetails),
                    
                    // An√°lise e recomenda√ß√µes
                    reasoning: person.ppvvc?.reasoning,
                    recommended_approach: person.ppvvc?.recommended_approach,
                    
                    // Status
                    status: person.tier === 'A' ? 'hot' : person.tier === 'B' ? 'qualified' : 'new',
                    assigned_to: person.tier === 'A' ? 'vendedor_senior' : 'sdr'
                })
            });
            
            if (response.ok) {
                alert('‚úÖ Prospecto salvo com sucesso no CRM!');
            } else {
                throw new Error('Erro ao salvar');
            }
        } catch (error) {
            console.error('Erro:', error);
            alert('‚ùå Erro ao salvar prospecto');
        }
    }

    function toggleAdvanced() {
        const div = document.getElementById('advancedFilters');
        div.classList.toggle('hidden');
    }

    function closeModal() {
        document.getElementById('analysisModal').classList.add('hidden');
    }

    function sortResults(by) {
        if (by === 'score') {
            analyzedResults.sort((a, b) => b.ventapelScore - a.ventapelScore);
        } else if (by === 'company') {
            analyzedResults.sort((a, b) => (a.organization?.name || '').localeCompare(b.organization?.name || ''));
        }
        displayResults(analyzedResults);
    }

    function filterTier(tier) {
        const filtered = analyzedResults.filter(r => r.tier === tier);
        displayResults(filtered);
    }

    // Busca por nome de empresa espec√≠fica
    async function searchByCompanyName() {
        const companyName = prompt('Digite o nome da empresa:');
        if (!companyName) return;
        
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '<p class="text-blue-600"><i class="fas fa-spinner fa-spin mr-2"></i>Buscando empresa...</p>';
        
        try {
            const response = await fetch('/api/apollo-search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: companyName,
                    filters: {
                        location: 'Brazil'
                    }
                })
            });
            
            if (!response.ok) throw new Error('Erro na busca');
            
            const data = await response.json();
            currentResults = data.people || [];
            
            await analyzeAndScoreProspects(currentResults);
            
        } catch (error) {
            console.error('Erro:', error);
            resultsDiv.innerHTML = `<p class="text-red-600">Erro: ${error.message}</p>`;
        }
    }
    </script>
</body>
</html>
