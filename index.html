<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ventapel Prospector - Sistema Inteligente PPVVC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-lg border-b-4 border-blue-600">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div>
                    <h1 class="text-2xl font-bold">Ventapel Prospector Brasil</h1>
                    <p class="text-xs text-gray-600">Sistema de Qualificação PPVVC - Mercado Brasileiro</p>
                </div>
                <div class="text-sm text-gray-600">
                    <span class="bg-green-100 px-2 py-1 rounded">Apollo</span>
                    <span class="bg-purple-100 px-2 py-1 rounded">Claude AI</span>
                    <span class="bg-blue-100 px-2 py-1 rounded">Supabase</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- Filtros de Score Automático -->
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
            <div class="flex items-center">
                <i class="fas fa-info-circle text-yellow-600 mr-2"></i>
                <div>
                    <p class="text-sm font-semibold">Sistema de Scoring Automático Ativo</p>
                    <p class="text-xs text-gray-600">
                        Volume mínimo: 10.000 envios/mês | Faturamento: >R$ 50M | 
                        Foco: E-commerce, 3PL, Alimentos, Farmacêutica, Cosmética, Automotiva
                    </p>
                </div>
            </div>
        </div>

        <!-- Painel de Busca Inteligente -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">
                <i class="fas fa-search mr-2"></i>Busca Inteligente de Prospectos B2B
            </h2>
            
            <!-- Filtros Principais -->
            <div class="grid grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Indústria Prioritária</label>
                    <select id="industryFilter" class="w-full p-2 border rounded">
                        <option value="">Todas as Indústrias</option>
                        <option value="e-commerce">E-commerce/Marketplace (Alta Prioridade)</option>
                        <option value="logistics">3PL/Logística/Fulfillment (Alta)</option>
                        <option value="food">Alimentos e Bebidas (Alta)</option>
                        <option value="pharma">Farmacêutica/Hospitalar (Alta)</option>
                        <option value="cosmetics">Cosmética/Beleza (Alta)</option>
                        <option value="automotive">Automotiva/Autopeças (Média)</option>
                        <option value="retail">Varejo/Têxtil (Média)</option>
                        <option value="manufacturing">Indústria Geral (Baixa)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Cargo Estratégico (Decisor)</label>
                    <select id="titleFilter" class="w-full p-2 border rounded">
                        <option value="quality">Gerente de Qualidade (Score +15)</option>
                        <option value="operations">Gerente de Operações (Score +15)</option>
                        <option value="logistics">Gerente de Logística (Score +15)</option>
                        <option value="production">Gerente de Produção (Score +15)</option>
                        <option value="supply">Gerente Supply Chain (Score +15)</option>
                        <option value="director">Diretor Operações/Industrial (Score +20)</option>
                        <option value="vp">VP/Head de Operações (Score +20)</option>
                        <option value="ceo">CEO/Presidente (Score +25)</option>
                        <option value="compras">Compras/Procurement (Score +5)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Região Brasil (Foco)</label>
                    <select id="locationFilter" class="w-full p-2 border rounded">
                        <option value="São Paulo, Brazil">São Paulo - SP (Prioridade)</option>
                        <option value="Rio de Janeiro, Brazil">Rio de Janeiro - RJ</option>
                        <option value="Minas Gerais, Brazil">Minas Gerais - MG</option>
                        <option value="Santa Catarina, Brazil">Santa Catarina - SC</option>
                        <option value="Paraná, Brazil">Paraná - PR</option>
                        <option value="Rio Grande do Sul, Brazil">Rio Grande do Sul - RS</option>
                        <option value="Brazil">Brasil (Todos Estados)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Porte da Empresa</label>
                    <select id="sizeFilter" class="w-full p-2 border rounded">
                        <option value="5001,10000">5001+ funcionários (Enterprise)</option>
                        <option value="1001,5000">1001-5000 (Grande Porte)</option>
                        <option value="501,1000">501-1000 (Médio-Grande)</option>
                        <option value="201,500">201-500 (Médio)</option>
                        <option value="51,200">51-200 (Pequeno-Médio)</option>
                    </select>
                </div>
            </div>

            <!-- Filtros Avançados de Qualificação -->
            <div class="border-t pt-4 mb-4">
                <button onclick="toggleAdvanced()" class="text-sm text-blue-600 hover:text-blue-800">
                    <i class="fas fa-cog mr-1"></i>Filtros Avançados de Qualificação
                </button>
                <div id="advancedFilters" class="hidden mt-4 space-y-3">
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Palavras-chave de Dor</label>
                            <input type="text" id="painKeywords" 
                                   placeholder="devolução, avaria, violação, roubo" 
                                   class="w-full p-2 border rounded text-sm">
                            <p class="text-xs text-gray-500 mt-1">+10 pontos se encontrado</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Sinais de Compra</label>
                            <input type="text" id="buySignals" 
                                   placeholder="expansão, nova fábrica, IPO" 
                                   class="w-full p-2 border rounded text-sm">
                            <p class="text-xs text-gray-500 mt-1">+15 pontos se encontrado</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Tecnologias Atuais</label>
                            <input type="text" id="techKeywords" 
                                   placeholder="SAP, WMS, Totvs" 
                                   class="w-full p-2 border rounded text-sm">
                            <p class="text-xs text-gray-500 mt-1">Indica maturidade digital</p>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-3 rounded">
                        <p class="text-xs font-semibold mb-2">Descalificadores Automáticos:</p>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <label class="flex items-center">
                                <input type="checkbox" id="excludeSmall" checked class="mr-2">
                                Excluir <1000 envios/mês
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="excludeRetail" checked class="mr-2">
                                Excluir varejo físico sem e-commerce
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="excludeRJ" class="mr-2">
                                Excluir empresas em RJ
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="excludeClients" class="mr-2">
                                Excluir clientes atuais
                            </label>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Score Mínimo (0-100)</label>
                            <select id="minScore" class="w-full p-2 border rounded">
                                <option value="0">Sem mínimo</option>
                                <option value="50">≥50 (Tier C - Nutrir)</option>
                                <option value="60">≥60 (Tier B - 72h)</option>
                                <option value="70">≥70 (Tier A - 24h)</option>
                                <option value="80">≥80 (Hot Lead)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Faturamento Anual Estimado</label>
                            <select id="revenueFilter" class="w-full p-2 border rounded">
                                <option value="">Todos</option>
                                <option value="50">≥R$ 50M</option>
                                <option value="200">≥R$ 200M (Ideal)</option>
                                <option value="500">≥R$ 500M (Estratégico)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-between items-center">
                <button onclick="searchProspects()" 
                        class="px-6 py-3 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                    <i class="fas fa-search mr-2"></i>Buscar Prospectos Qualificados
                </button>
                
                <div class="flex gap-2">
                    <button onclick="searchByCompanyName()" 
                            class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm">
                        <i class="fas fa-building mr-2"></i>Buscar Empresa Específica
                    </button>
                    <button onclick="exportResults('csv')" 
                            class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
                        <i class="fas fa-download mr-2"></i>Exportar CSV
                    </button>
                    <button onclick="exportResults('excel')" 
                            class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm">
                        <i class="fas fa-file-excel mr-2"></i>Exportar Excel
                    </button>
                </div>
            </div>
        </div>

        <!-- Painel de Métricas e KPIs -->
        <div class="grid grid-cols-5 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-2xl font-bold text-blue-600" id="totalFound">0</div>
                <div class="text-xs text-gray-600">Prospectos Encontrados</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-2xl font-bold text-green-600" id="avgScore">0</div>
                <div class="text-xs text-gray-600">Score Médio (0-100)</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-2xl font-bold text-purple-600" id="withContact">0</div>
                <div class="text-xs text-gray-600">Com Contato</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-2xl font-bold text-orange-600" id="tierA">0</div>
                <div class="text-xs text-gray-600">Tier A (24h)</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-2xl font-bold text-yellow-600" id="tierB">0</div>
                <div class="text-xs text-gray-600">Tier B (72h)</div>
            </div>
        </div>

        <!-- Resultados com Scoring -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold">Resultados com Análise PPVVC</h3>
                <div class="flex gap-2">
                    <button onclick="sortResults('score')" class="text-sm px-3 py-1 border rounded hover:bg-gray-50">
                        <i class="fas fa-sort-amount-down"></i> Por Score
                    </button>
                    <button onclick="sortResults('company')" class="text-sm px-3 py-1 border rounded hover:bg-gray-50">
                        <i class="fas fa-sort-alpha-down"></i> Por Empresa
                    </button>
                    <button onclick="filterTier('A')" class="text-sm px-3 py-1 border rounded hover:bg-orange-50 text-orange-600">
                        <i class="fas fa-fire"></i> Só Tier A
                    </button>
                </div>
            </div>
            <div id="results">
                <p class="text-gray-500">Nenhuma busca realizada</p>
            </div>
        </div>
    </div>

    <!-- Modal de Análise PPVVC Detalhada -->
    <div id="analysisModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-[700px] shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Análise Detalhada PPVVC + Scoring</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="analysisContent"></div>
            </div>
        </div>
    </div>

    <script>
    // CONFIGURAÇÃO BASEADA NOS DOCUMENTOS VENTAPEL
    const INDUSTRY_MAPPING = {
        'e-commerce': {
            keywords: ['e-commerce', 'marketplace', 'comércio eletrônico', 'loja virtual', 'online'],
            score: 10,
            priority: 'alta'
        },
        'logistics': {
            keywords: ['logística', '3PL', 'fulfillment', 'armazém', 'distribuição', 'supply chain'],
            score: 10,
            priority: 'alta'
        },
        'food': {
            keywords: ['alimentos', 'bebidas', 'food', 'alimentício', 'FMCG'],
            score: 10,
            priority: 'alta'
        },
        'pharma': {
            keywords: ['farmacêutica', 'pharmaceutical', 'medicamentos', 'hospitalar', 'saúde'],
            score: 10,
            priority: 'alta'
        },
        'cosmetics': {
            keywords: ['cosmética', 'beleza', 'beauty', 'personal care', 'higiene'],
            score: 10,
            priority: 'alta'
        },
        'automotive': {
            keywords: ['automotiva', 'automotive', 'autopeças', 'veículos', 'montadora'],
            score: 5,
            priority: 'média'
        },
        'retail': {
            keywords: ['varejo', 'retail', 'loja', 'moda', 'têxtil', 'fashion'],
            score: 3,
            priority: 'média'
        },
        'manufacturing': {
            keywords: ['indústria', 'manufatura', 'fábrica', 'industrial', 'produção'],
            score: 2,
            priority: 'baixa'
        }
    };

    const TITLE_MAPPING = {
        'quality': {
            titles: ['Gerente de Qualidade', 'Gerente da Qualidade', 'Quality Manager', 'Coordenador de Qualidade'],
            score: 15
        },
        'operations': {
            titles: ['Gerente de Operações', 'Operations Manager', 'Gerente Operacional', 'COO'],
            score: 15
        },
        'logistics': {
            titles: ['Gerente de Logística', 'Logistics Manager', 'Gerente Logístico', 'Supply Chain Manager'],
            score: 15
        },
        'production': {
            titles: ['Gerente de Produção', 'Production Manager', 'Gerente Industrial', 'Plant Manager'],
            score: 15
        },
        'supply': {
            titles: ['Supply Chain Manager', 'Gerente de Supply Chain', 'Head of Supply Chain'],
            score: 15
        },
        'director': {
            titles: ['Diretor de Operações', 'Diretor Industrial', 'Operations Director', 'VP Operations'],
            score: 20
        },
        'vp': {
            titles: ['VP', 'Vice President', 'Vice-Presidente', 'Head of Operations'],
            score: 20
        },
        'ceo': {
            titles: ['CEO', 'President', 'Presidente', 'Chief Executive', 'Sócio Diretor'],
            score: 25
        },
        'compras': {
            titles: ['Compras', 'Procurement', 'Suprimentos', 'Buyer', 'Comprador'],
            score: 5
        }
    };

    // Clientes atuais para excluir
    const CURRENT_CLIENTS = [
        'Mercado Livre', 'Amazon', 'Honda', 'Toyota', 'L\'Oréal', 
        'Nike', 'Puma', 'Nestlé', 'Bayer', 'McCain'
    ];

    let currentResults = [];
    let analyzedResults = [];

    async function searchProspects() {
        const industry = document.getElementById('industryFilter').value;
        const titleType = document.getElementById('titleFilter').value;
        const location = document.getElementById('locationFilter').value;
        const size = document.getElementById('sizeFilter').value;
        
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '<p class="text-blue-600"><i class="fas fa-spinner fa-spin mr-2"></i>Buscando prospectos qualificados...</p>';
        
        try {
            // 1. Buscar en Apollo
            const response = await fetch('/api/apollo-search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: '',
                    filters: {
                        titles: TITLE_MAPPING[titleType]?.titles || ['Gerente', 'Manager', 'Diretor'],
                        location: location || 'Brazil',
                        size: size
                    }
                })
            });
            
            if (!response.ok) throw new Error(`Error ${response.status}`);
            
            const data = await response.json();
            let prospects = data.people || [];
            
            // Store for export
            currentResults = prospects;
            
            // 2. ENRIQUECER CON SERPER
            resultsDiv.innerHTML = '<p class="text-purple-600"><i class="fas fa-spinner fa-spin mr-2"></i>Enriquecendo com inteligência de mercado...</p>';
            
            const enrichedProspects = [];
            for (const prospect of prospects.slice(0, 5)) { // Solo los primeros 5 para no gastar créditos
                if (prospect.organization?.name) {
                    try {
                        const enrichResponse = await fetch('/api/enrich-prospect', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                company: prospect.organization,
                                contact: prospect
                            })
                        });
                        
                        const enrichData = await enrichResponse.json();
                        
                        enrichedProspects.push({
                            ...prospect,
                            enrichment: enrichData.enriched ? enrichData.enrichmentData : null,
                            enrichmentScore: enrichData.additionalScore || 0,
                            enrichmentSummary: enrichData.summary || ''
                        });
                    } catch (error) {
                        console.error('Error enriching:', error);
                        enrichedProspects.push(prospect);
                    }
                } else {
                    enrichedProspects.push(prospect);
                }
            }
            
            // Agregar los no enriquecidos
            enrichedProspects.push(...prospects.slice(5));
            
            // Store enriched results for export
            analyzedResults = enrichedProspects;
            
            // 3. Mostrar resultados enriquecidos
            displayEnrichedResults(enrichedProspects);
            
        } catch (error) {
            console.error('Error:', error);
            resultsDiv.innerHTML = `
                <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
                    <p class="font-bold">Erro ao buscar prospectos</p>
                    <p class="text-sm">${error.message}</p>
                </div>
            `;
        }
    }

    function displayEnrichedResults(prospects) {
        const resultsDiv = document.getElementById('results');
        
        if (prospects.length === 0) {
            resultsDiv.innerHTML = '<p class="text-gray-500">Nenhum prospecto encontrado</p>';
            return;
        }
        
        let html = '<div class="space-y-4">';
        
        prospects.forEach(person => {
            const hasEnrichment = person.enrichment && person.enrichmentScore > 0;
            const borderColor = hasEnrichment && person.enrichmentScore > 20 ? 'border-orange-400' : 'border-gray-200';
            
            html += `
                <div class="border ${borderColor} rounded-lg p-4 hover:shadow-md transition-shadow ${hasEnrichment ? 'bg-orange-50' : ''}">
                    <div class="flex justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <h4 class="font-semibold text-lg">${person.name || 'Nome não disponível'}</h4>
                                ${hasEnrichment && person.enrichmentScore > 20 ? 
                                    '<span class="px-2 py-1 bg-orange-500 text-white text-xs rounded">🔥 HOT LEAD</span>' : ''}
                            </div>
                            
                            <p class="text-gray-600">${person.title || 'Cargo não especificado'}</p>
                            <p class="text-blue-600 font-medium">${person.organization?.name || 'Empresa não especificada'}</p>
                            
                            <!-- Dados de contato -->
                            <div class="mt-2 text-sm space-y-1">
                                ${person.email ? `
                                    <div>
                                        <i class="fas fa-envelope mr-1 text-gray-400"></i>
                                        <a href="mailto:${person.email}" class="text-blue-500">${person.email}</a>
                                    </div>
                                ` : '<div class="text-gray-400"><i class="fas fa-envelope mr-1"></i>Email não disponível</div>'}
                                
                                ${person.phone_numbers?.[0] ? `
                                    <div>
                                        <i class="fas fa-phone mr-1 text-gray-400"></i>
                                        ${person.phone_numbers[0].sanitized_number || person.phone_numbers[0].number}
                                    </div>
                                ` : ''}
                                
                                ${person.linkedin_url ? `
                                    <div>
                                        <i class="fab fa-linkedin mr-1 text-gray-400"></i>
                                        <a href="${person.linkedin_url}" target="_blank" class="text-blue-500">Ver LinkedIn</a>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- ENRIQUECIMENTO SERPER -->
                            ${hasEnrichment ? `
                                <div class="mt-3 p-3 bg-white rounded border border-yellow-400">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-sm font-semibold">🔍 Inteligência de Mercado</span>
                                        <span class="text-xs bg-yellow-100 px-2 py-1 rounded">+${person.enrichmentScore} pontos</span>
                                    </div>
                                    
                                    ${person.enrichment.publicProblems?.length > 0 ? `
                                        <div class="text-sm text-red-600 mb-2">
                                            <i class="fas fa-exclamation-triangle mr-1"></i>
                                            <strong>Problemas detectados:</strong> ${person.enrichment.publicProblems[0].issue}
                                        </div>
                                    ` : ''}
                                    
                                    ${person.enrichment.buyingSignals?.length > 0 ? `
                                        <div class="text-sm text-green-600 mb-2">
                                            <i class="fas fa-shopping-cart mr-1"></i>
                                            <strong>Buscando fornecedores!</strong>
                                        </div>
                                    ` : ''}
                                    
                                    ${person.enrichment.news?.length > 0 ? `
                                        <div class="text-sm text-blue-600 mb-2">
                                            <i class="fas fa-newspaper mr-1"></i>
                                            <strong>Notícia recente:</strong> ${person.enrichment.news[0].title}
                                        </div>
                                    ` : ''}
                                    
                                    ${person.enrichment.ergonomicProblems?.length > 0 ? `
                                        <div class="text-sm text-purple-600 mb-2">
                                            <i class="fas fa-user-injured mr-1"></i>
                                            <strong>Problemas ergonômicos detectados</strong>
                                        </div>
                                    ` : ''}
                                    
                                    ${person.enrichmentSummary ? `
                                        <div class="text-xs text-gray-700 mt-2 pt-2 border-t">
                                            ${person.enrichmentSummary}
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="ml-4 space-y-2">
                            ${hasEnrichment && person.enrichmentScore > 20 ? `
                                <button onclick="generateQuickMessage(${JSON.stringify(person).replace(/'/g, '&apos;').replace(/"/g, '&quot;')})" 
                                        class="px-4 py-2 bg-orange-600 text-white rounded text-sm hover:bg-orange-700 w-full">
                                    <i class="fas fa-bolt mr-1"></i>Ação Imediata
                                </button>
                            ` : ''}
                            
                            <button onclick="saveProspect(${JSON.stringify(person).replace(/'/g, '&apos;').replace(/"/g, '&quot;')})" 
                                    class="px-4 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700 w-full">
                                <i class="fas fa-save mr-1"></i>Salvar
                            </button>
                            
                            ${person.linkedin_url ? `
                                <button onclick="window.open('${person.linkedin_url}', '_blank')" 
                                        class="px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 w-full">
                                    <i class="fab fa-linkedin mr-1"></i>LinkedIn
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        resultsDiv.innerHTML = html;
        
        // Actualizar estadísticas
        updateEnrichedStats(prospects);
    }

    function updateEnrichedStats(prospects) {
        document.getElementById('totalFound').textContent = prospects.length;
        
        const withContact = prospects.filter(p => p.email || p.phone_numbers?.length > 0).length;
        document.getElementById('withContact').textContent = withContact;
        
        const hotLeads = prospects.filter(p => p.enrichmentScore > 20).length;
        document.getElementById('tierA').textContent = hotLeads;
        
        const avgScore = prospects.length > 0 ? 
            prospects.reduce((sum, p) => sum + (p.enrichmentScore || 0), 0) / prospects.length : 0;
        document.getElementById('avgScore').textContent = Math.round(avgScore);
        
        const tierB = prospects.filter(p => p.enrichmentScore >= 10 && p.enrichmentScore <= 20).length;
        document.getElementById('tierB').textContent = tierB;
    }

    function generateQuickMessage(person) {
        let message = `Olá ${person.name?.split(' ')[0] || 'Prezado(a)'},\n\n`;
        
        if (person.enrichment?.publicProblems?.length > 0) {
            message += `Vi que a ${person.organization?.name} está enfrentando desafios logísticos. `;
            message += `Ajudamos empresas similares a eliminar 100% das violações em trânsito.\n\n`;
        } else if (person.enrichment?.buyingSignals?.length > 0) {
            message += `Notei que vocês estão buscando novos fornecedores. `;
            message += `Somos parceiros de Mercado Livre e Amazon em soluções de fechamento.\n\n`;
        } else if (person.enrichment?.ergonomicProblems?.length > 0) {
            message += `A saúde ocupacional é crítica. Nossa solução elimina movimentos repetitivos e reduz afastamentos.\n\n`;
        } else {
            message += `Ajudamos empresas como a ${person.organization?.name} a reduzir 64% dos custos de fechamento.\n\n`;
        }
        
        message += `Podemos agendar 15 minutos esta semana?\n\n`;
        message += `Abraços,\n[Seu Nome]\nVentapel Brasil`;
        
        navigator.clipboard.writeText(message);
        alert('Mensagem copiada para área de transferência!');
    }

    function saveProspect(person) {
        // Aqui você pode implementar o salvamento real
        console.log('Salvando:', person);
        
        // Simular salvamento
        const savedProspects = JSON.parse(localStorage.getItem('ventapelProspects') || '[]');
        savedProspects.push({
            ...person,
            savedAt: new Date().toISOString()
        });
        localStorage.setItem('ventapelProspects', JSON.stringify(savedProspects));
        
        alert('✅ Prospecto salvo localmente!');
    }

    function exportResults(format) {
        // Usar analyzedResults si existe (con enriquecimiento), sino currentResults
        const dataToExport = analyzedResults.length > 0 ? analyzedResults : currentResults;
        
        if (dataToExport.length === 0) {
            alert('Nenhum resultado para exportar');
            return;
        }
        
        if (format === 'csv' || format === 'excel') {
            // Crear CSV con BOM para Excel en portugués
            const BOM = '\uFEFF';
            let csvContent = BOM + "Nome,Cargo,Empresa,Email,Telefone,LinkedIn,Score,Indústria,Funcionários,Cidade,Estado,Problemas Detectados,Sinais de Compra,Notícias,Próxima Ação\n";
            
            dataToExport.forEach(person => {
                // Preparar datos de enriquecimiento
                const problems = person.enrichment?.publicProblems?.map(p => p.issue).join('; ') || '';
                const buyingSignals = person.enrichment?.buyingSignals?.length > 0 ? 'SIM' : 'NÃO';
                const news = person.enrichment?.news?.[0]?.title || '';
                const nextAction = person.enrichmentScore > 20 ? 'Contatar em 24h' : 
                                  person.enrichmentScore > 10 ? 'Contatar em 72h' : 'Nutrir';
                
                const row = [
                    person.name || '',
                    person.title || '',
                    person.organization?.name || '',
                    person.email || '',
                    person.phone_numbers?.[0]?.sanitized_number || '',
                    person.linkedin_url || '',
                    person.enrichmentScore || '0',
                    person.organization?.industry || '',
                    person.organization?.estimated_num_employees || '',
                    person.organization?.city || '',
                    person.organization?.state || '',
                    problems,
                    buyingSignals,
                    news,
                    nextAction
                ].map(field => {
                    // Escapar campos con comas o quotes
                    const fieldStr = String(field);
                    if (fieldStr.includes(',') || fieldStr.includes('"') || fieldStr.includes('\n')) {
                        return `"${fieldStr.replace(/"/g, '""')}"`;
                    }
                    return fieldStr;
                }).join(',');
                
                csvContent += row + "\n";
            });
            
            // Crear blob y descargar
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            const fileName = `ventapel_prospectos_${new Date().toISOString().split('T')[0]}.csv`;
            
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Mostrar mensaje de éxito
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded z-50';
            successDiv.innerHTML = `
                <span class="block sm:inline">✅ Exportado ${dataToExport.length} prospectos para ${fileName}</span>
            `;
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }
    }

    function toggleAdvanced() {
        const div = document.getElementById('advancedFilters');
        div.classList.toggle('hidden');
    }

    function closeModal() {
        document.getElementById('analysisModal').classList.add('hidden');
    }

    function sortResults(by) {
        const sorted = [...analyzedResults];
        if (by === 'score') {
            sorted.sort((a, b) => (b.enrichmentScore || 0) - (a.enrichmentScore || 0));
        } else if (by === 'company') {
            sorted.sort((a, b) => (a.organization?.name || '').localeCompare(b.organization?.name || ''));
        }
        displayEnrichedResults(sorted);
    }

    function filterTier(tier) {
        const filtered = analyzedResults.filter(r => {
            if (tier === 'A') return r.enrichmentScore > 20;
            if (tier === 'B') return r.enrichmentScore >= 10 && r.enrichmentScore <= 20;
            return r.enrichmentScore < 10;
        });
        displayEnrichedResults(filtered);
    }

    // Busca por nome de empresa específica
    async function searchByCompanyName() {
        const companyName = prompt('Digite o nome da empresa:');
        if (!companyName) return;
        
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '<p class="text-blue-600"><i class="fas fa-spinner fa-spin mr-2"></i>Buscando empresa...</p>';
        
        try {
            const response = await fetch('/api/apollo-search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: companyName,
                    filters: {
                        location: 'Brazil'
                    }
                })
            });
            
            if (!response.ok) throw new Error('Erro na busca');
            
            const data = await response.json();
            currentResults = data.people || [];
            
            // Enriquecer y mostrar
            await searchProspects(); // Reutilizar la lógica de enriquecimiento
            
        } catch (error) {
            console.error('Erro:', error);
            resultsDiv.innerHTML = `<p class="text-red-600">Erro: ${error.message}</p>`;
        }
    }
    </script>
</body>
</html>
